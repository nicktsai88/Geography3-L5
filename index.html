<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ç†ç¬¬3å†Š L5æ±åŒ—äºçš„è‡ªç„¶ç’°å¢ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=CwTeXYen:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #FF8C42; 
            --secondary-color: #F9F871; 
            --bg-color: #FFF5E1; 
            --text-color: #4A4A4A;
            --accent-color: #FF5E5E; 
            --correct-color: #2ECC71;
            --wrong-color: #E74C3C;
            --locked-color: #BDC3C7;
            --music-btn-color: #3498db; 
            --quick-mode-color: #9b59b6; /* ç´«è‰²ä¸»é¡Œ */
        }

        body { 
            font-family: 'CwTeXYen', "Microsoft JhengHei", Arial, sans-serif; 
            max-width: 1000px; 
            margin: 0 auto; 
            padding: 20px; 
            background-color: var(--bg-color); 
            color: var(--text-color);
            background-image: url('images/background.jpg'); /* èƒŒæ™¯åœ–ç‰‡ */
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            min-height: 100vh;
        }

        /* å¢åŠ é®ç½©è®“æ–‡å­—æ¸…æ¥š */
        body::before {
            content: "";
            position: fixed;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(255, 245, 225, 0.85); /* åŠé€æ˜é®ç½© */
            z-index: -1;
        }

        h1 { font-size: 2.5em; color: #D35400; text-align: center; margin-top: 0; text-shadow: 2px 2px 0px white; }
        h2, h3 { color: #D35400; text-align: center; }

        /* --- ä¸»è¦å®¹å™¨ --- */
        .quiz-container { 
            background: rgba(255, 255, 255, 0.95);
            padding: 30px; 
            border-radius: 25px; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            border: 4px solid var(--primary-color);
            position: relative;
            overflow: hidden;
            min-height: 600px;
        }

        /* --- å‹•ç•«ç‰¹æ•ˆ --- */
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        .fade-in { animation: fadeIn 0.4s ease-out; }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 10px 20px; font-size: 1.1em; border-radius: 50px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 4px 0 #E67E22;
            font-family: inherit; font-weight: bold; margin: 5px; display: inline-flex;
            align-items: center; justify-content: center; gap: 5px;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-green { background-color: var(--correct-color); box-shadow: 0 4px 0 #27AE60; }
        .btn-red { background-color: var(--accent-color); box-shadow: 0 4px 0 #C0392B; }
        .btn-gray { background-color: #95a5a6; box-shadow: 0 4px 0 #7f8c8d; }
        .btn-blue { background-color: #3498db; box-shadow: 0 4px 0 #2980b9; }
        .btn-purple { background-color: var(--quick-mode-color); box-shadow: 0 4px 0 #8e44ad; }
        
        .btn-sm { padding: 6px 12px; font-size: 0.9em; margin: 0 2px; }

        /* --- è¼¸å…¥æ¡†èˆ‡å¿«é€Ÿç™»å…¥ --- */
        input[type="text"] {
            padding: 12px; font-size: 1.5em; 
            border: 3px solid var(--primary-color);
            border-radius: 15px; margin: 15px; font-family: inherit; text-align: center; width: 80%;
        }
        .quick-login-area { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .user-tag {
            background: #FFF0D4; border: 2px solid var(--primary-color);
            padding: 8px 15px; border-radius: 20px; cursor: pointer;
            font-size: 1.1em; transition: 0.2s; color: #D35400;
            display: flex; align-items: center; gap: 8px;
        }
        .user-tag:hover { background: var(--primary-color); color: white; }
        .delete-user { font-size: 0.9em; cursor: pointer; padding: 2px 6px; border-radius: 50%; background: rgba(255,255,255,0.5); transition: 0.2s; }
        .delete-user:hover { background: #E74C3C; color: white; transform: scale(1.2); }

        /* --- è§’è‰²é¸æ“‡ --- */
        .avatar-selection { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .avatar-option {
            width: 80px; height: 80px; border-radius: 50%; border: 4px solid transparent;
            cursor: pointer; transition: 0.3s; object-fit: cover; background: white; padding: 2px;
        }
        .avatar-option.selected { border-color: var(--correct-color); box-shadow: 0 0 15px var(--correct-color); transform: scale(1.1); background: #e8f8f5; }

        /* --- å„€è¡¨æ¿ (Dashboard) æ–°è¨­è¨ˆ --- */
        #dashboard-container {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-panel {
            background: rgba(255,255,255,0.8);
            border-radius: 20px;
            padding: 20px;
            border: 2px solid #ddd;
        }

        .dashboard-title {
            font-size: 1.5em;
            margin-bottom: 15px;
            text-align: center;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        /* æ¨™æº–æ¨¡å¼ï¼šGrid åœ°åœ– */
        .level-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(70px, 1fr));
            gap: 10px;
            justify-items: center;
        }

        .level-btn-grid {
            width: 60px; height: 60px;
            border-radius: 15px;
            border: 3px solid var(--primary-color);
            background: white;
            color: var(--primary-color);
            font-weight: bold;
            cursor: pointer;
            transition: 0.2s;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            font-size: 1em;
        }
        .level-btn-grid:hover:not(:disabled) { transform: scale(1.1); background: #FFF0D4; }
        .level-btn-grid:disabled { border-color: #ccc; color: #ccc; cursor: not-allowed; background: #eee; }
        .level-btn-grid.completed { background: #e8f8f5; border-color: var(--correct-color); color: var(--correct-color); }
        .level-star { font-size: 0.8em; margin-top: -2px; }

        /* æ¥µé€Ÿåˆ·é¡Œå€ (ç´«è‰²ä¸»é¡Œ) */
        .quick-mode-panel { border-color: var(--quick-mode-color); background: #fdf5ff; }
        .quick-mode-title { color: var(--quick-mode-color); }
        
        .big-start-btn {
            width: 100%;
            padding: 30px;
            font-size: 1.8em;
            background: var(--quick-mode-color);
            color: white;
            border-radius: 20px;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            box-shadow: 0 6px 0 #8e44ad;
            display: flex; flex-direction: column; align-items: center; gap: 10px;
        }
        .big-start-btn:hover { transform: translateY(-3px); box-shadow: 0 8px 0 #8e44ad; }
        .big-start-btn:active { transform: translateY(2px); box-shadow: none; }
        
        /* å„€è¡¨æ¿åº•éƒ¨å·¥å…·åˆ— */
        .dashboard-footer {
            margin-top: 20px;
            display: flex;
            flex-wrap: wrap;
            justify-content: center;
            gap: 10px;
            background: white;
            padding: 15px;
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
        }

        /* --- ç€‘å¸ƒæµåˆ·é¡Œæ¨¡å¼ (Waterfall Mode) --- */
        #waterfall-screen { position: relative; height: 80vh; overflow-y: auto; scroll-behavior: smooth; border-radius: 15px; border: 2px solid #ddd; background: #f9f9f9; }
        
        .sticky-header {
            position: sticky; top: 0; left: 0; right: 0;
            background: rgba(255, 255, 255, 0.95);
            padding: 10px 20px;
            z-index: 100;
            border-bottom: 3px solid var(--primary-color);
            box-shadow: 0 5px 10px rgba(0,0,0,0.1);
            display: flex; justify-content: space-between; align-items: center;
        }
        .sticky-header.purple { border-color: var(--quick-mode-color); }

        .wf-score-board { font-size: 1.2em; font-weight: bold; color: #555; }
        .wf-score-val { color: var(--correct-color); font-size: 1.4em; }

        .waterfall-container { padding: 20px; padding-bottom: 80px; }

        .quiz-card {
            background: white;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.05);
            border-left: 6px solid #ccc;
            position: relative;
        }
        .quiz-card.answered-correct { border-left-color: var(--correct-color); background: #f0fff4; }
        .quiz-card.answered-wrong { border-left-color: var(--wrong-color); background: #fff5f5; }

        .card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .card-question { font-size: 1.3em; font-weight: bold; width: 85%; line-height: 1.4; }
        
        .card-actions { display: flex; gap: 8px; }
        .icon-btn { 
            background: none; border: none; cursor: pointer; font-size: 1.5em; 
            transition: 0.2s; opacity: 0.3; padding: 5px;
        }
        .icon-btn:hover { opacity: 0.7; transform: scale(1.2); }
        .icon-btn.active { opacity: 1; transform: scale(1.1); }
        .icon-heart.active { color: #FF5E5E; }
        .icon-trash { color: #E74C3C; } /* åƒåœ¾æ¡¶é¡è‰² */

        .card-img { max-width: 100%; height: auto; border-radius: 10px; margin-bottom: 15px; border: 1px solid #eee; display: none; }

        .wf-options { display: flex; flex-direction: column; gap: 8px; }
        .wf-option {
            padding: 12px 15px;
            border: 2px solid #eee;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1.1em;
            background: white;
            text-align: left;
            transition: 0.2s;
        }
        .wf-option:hover:not(.disabled) { background: #fff9e6; border-color: var(--primary-color); }
        .wf-option.disabled { cursor: default; }
        
        /* ç‹€æ…‹æ¨£å¼ */
        .wf-option.correct-sel { background: #d4edda; border-color: #28a745; color: #155724; font-weight: bold; }
        .wf-option.wrong-sel { background: #f8d7da; border-color: #dc3545; color: #721c24; }
        .wf-option.correct-ans { background: #d4edda; border-color: #28a745; color: #155724; border: 2px dashed #28a745; }

        .wf-explanation {
            margin-top: 15px; padding: 15px; background: #e8f4f8; 
            border-radius: 10px; color: #2980b9; line-height: 1.5; display: none;
            border-left: 4px solid #3498db;
        }

        /* --- æ¨™æº–æ¨¡å¼ (å–®é¡Œ) --- */
        .question-box { background-color: #FFF9F0; border-left: 8px solid var(--accent-color); padding: 20px; margin-bottom: 20px; border-radius: 15px; position: relative; }
        .std-fav-btn { position: absolute; top: 15px; right: 15px; font-size: 1.8em; background:none; border:none; cursor:pointer; color:#ccc; transition:0.3s; }
        .std-fav-btn.active { color: #FF5E5E; }
        
        .progress-container { width: 100%; background-color: #eee; border-radius: 10px; margin: 15px 0; height: 25px; overflow: hidden; }
        .progress-bar { height: 100%; background-color: var(--correct-color); width: 0%; transition: width 0.3s ease; }
        
        /* --- å…¶ä»– --- */
        .resume-btn-area { width: 100%; text-align: center; margin-top: 10px; }
        
        @media (max-width: 700px) {
            #dashboard-container { grid-template-columns: 1fr; }
            .sticky-header { font-size: 0.9em; padding: 8px 10px; }
            .btn { width: 100%; margin: 5px 0; }
        }
    </style>
</head>
<body>

    <div class="quiz-container">
        <audio id="bgm-player"></audio>

        <!-- 1. æ­¡è¿ç•«é¢ -->
        <div id="welcome-screen" class="fade-in">
            <h1>åœ°ç†ç¬¬3å†Š æ±åŒ—äºçš„è‡ªç„¶ç’°å¢ƒ</h1>
            <div style="font-size: 5em; margin: 30px; text-align: center;">ğŸŒâœ¨ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡·</div>
            <p style="font-size: 1.5em; text-align: center;">è«‹è¼¸å…¥ä½ çš„åå­—ä¸¦é¸æ“‡ä¸€ä½å†’éšªå¤¥ä¼´ï¼</p>
            <div style="text-align: center;">
                <input type="text" id="username" placeholder="ä½ çš„åå­—æ˜¯..." />
            </div>
            
            <div class="avatar-selection">
                <img src="images/avatar_boy1.png" class="avatar-option selected" onclick="selectAvatar('avatar_boy1.png', this)">
                <img src="images/avatar_boy2.png" class="avatar-option" onclick="selectAvatar('avatar_boy2.png', this)">
                <img src="images/avatar_girl1.png" class="avatar-option" onclick="selectAvatar('avatar_girl1.png', this)">
                <img src="images/avatar_girl2.png" class="avatar-option" onclick="selectAvatar('avatar_girl2.png', this)">
            </div>

            <div id="quick-login-area" class="quick-login-area"></div>

            <br><br>
            <div style="text-align: center;">
                <button class="btn" onclick="loginAndStart()">ğŸ‘‰ é€²å…¥é—œå¡åœ°åœ–</button>
            </div>
        </div>

        <!-- 2. å„€è¡¨æ¿ (Dashboard) -->
        <div id="level-screen" style="display: none;" class="fade-in">
            <div style="text-align: center; margin-bottom: 10px;">
                <div style="background: rgba(255,255,255,0.9); padding:10px 20px; border-radius:50px; display:inline-flex; align-items:center; gap:10px; border:2px solid var(--primary-color);">
                    <img id="user-avatar-display" src="" style="width:40px; height:40px; border-radius:50%; border:2px solid #ddd;">
                    <span style="font-size: 1.2em;">å†’éšªå®¶ï¼š<span id="display-name" style="color:var(--primary-color); font-weight:bold;"></span></span>
                </div>
            </div>

            <div id="dashboard-container">
                <!-- å·¦å´ï¼šæ¨™æº–é—–é—œ -->
                <div class="dashboard-panel">
                    <div class="dashboard-title"><span style="font-size:1.5em">ğŸ§ª</span> æ¨™æº–é—–é—œæ¨¡å¼</div>
                    <div id="level-map" class="level-grid"></div>
                    <div id="std-resume-area" class="resume-btn-area" style="display:none;">
                        <button class="btn btn-sm btn-green" onclick="resumeStandardQuiz()">â†ªï¸ ç¹¼çºŒä¸Šæ¬¡çš„é—–é—œ</button>
                    </div>
                </div>

                <!-- å³å´ï¼šæ¥µé€Ÿåˆ·é¡Œ -->
                <div class="dashboard-panel quick-mode-panel">
                    <div class="dashboard-title quick-mode-title"><span style="font-size:1.5em">âš¡</span> æ¥µé€Ÿåˆ·é¡Œå€</div>
                    <p style="text-align:center; color:#666; margin-bottom:20px;">å…¨ç¯„åœé¡Œç›®ä¸€æ¬¡è¼‰å…¥ï¼Œ<br>é©åˆè€ƒå‰è¡åˆºè¤‡ç¿’ï¼</p>
                    <button class="big-start-btn" onclick="startQuiz('quick')">
                        <span style="font-size:2em;">ğŸš€</span>
                        <span>é–‹å§‹åˆ·é¡Œ (å…¨ç¯„åœ)</span>
                    </button>
                </div>
            </div>
            
            <div class="dashboard-footer">
                <button id="btn-mistake" class="btn btn-red" onclick="startQuiz('mistake')" style="display:none;">
                    ğŸ“• æŒ‘æˆ°éŒ¯é¡Œæœ¬ (<span id="mistake-count">0</span>)
                </button>
                <button class="btn btn-blue" onclick="startQuiz('collection')">
                    â­ é‡é»æ”¶è— (<span id="collection-count">0</span>)
                </button>
                <button class="btn btn-green" onclick="showHistory()">ğŸ“œ æŸ¥çœ‹ç´€éŒ„</button>
                
                <div style="display:inline-flex; gap:5px; align-items:center; background:#eee; padding:5px; border-radius:30px;">
                    <button class="btn btn-sm btn-music" onclick="toggleMusic()" title="æ’­æ”¾/æš«åœ">â¯ï¸</button>
                    <button class="btn btn-sm btn-music" onclick="nextTrack()" title="ä¸‹ä¸€é¦–">â­ï¸</button>
                </div>

                <button class="btn btn-gray" onclick="logout()">ğŸšª ç™»å‡º</button>
            </div>
        </div>

        <!-- 3. æ¨™æº–æ¸¬é©—æ¨¡å¼ (Standard Quiz) -->
        <div id="quiz-content" style="display: none;" class="fade-in">
            <div class="quiz-header">
                <h3 id="level-title" style="margin:0; font-size: 1.5em;">ç¬¬ X é—œ</h3>
                <div class="header-controls">
                    <button class="btn btn-gray btn-sm" onclick="exitQuiz()">ğŸ  æš«åœä¸¦è¿”å›</button>
                </div>
            </div>
            
            <div class="progress-container">
                <div id="progress-bar" class="progress-bar"></div>
            </div>
            <div style="text-align: right; font-size: 1.1em; color: gray;">
                é¡Œè™Ÿ: <span id="current-q-num">1</span> / <span id="total-q-num">20</span>
            </div>

            <div id="question-container" class="fade-in">
                <div class="question-box">
                    <button class="std-fav-btn" id="std-fav-btn" onclick="toggleFavoriteCurrent()">â¤</button>
                    <div id="question-text" class="question-text">é¡Œç›®è¼‰å…¥ä¸­...</div>
                    <img id="question-image" class="question-img" style="display: none;" />
                </div>
                <ul id="options-list" style="list-style: none; padding: 0;"></ul>
            </div>
            
            <div id="explanation" class="explanation-box" style="display: none;">
                <strong>ğŸ’¡ è§£æï¼š</strong> <span id="explanation-text"></span>
            </div>

            <button id="next-btn" class="btn" style="display: none; width: 100%; margin-top: 25px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡ï¸</button>
        </div>

        <!-- 4. ç€‘å¸ƒæµåˆ·é¡Œæ¨¡å¼ (Waterfall Quiz) -->
        <div id="waterfall-screen" style="display: none;" class="fade-in">
            <div id="wf-header" class="sticky-header">
                <div id="wf-title" style="font-weight:bold; font-size:1.1em;">ğŸš€ æ¥µé€Ÿåˆ·é¡Œ</div>
                <div class="wf-score-board">
                    ç­”å°: <span id="wf-correct-count" class="wf-score-val">0</span> / <span id="wf-total-count">0</span>
                </div>
                <button class="btn btn-sm btn-gray" onclick="exitWaterfall()">ğŸ  çµæŸ</button>
            </div>
            <div id="waterfall-container" class="waterfall-container">
                <!-- é¡Œç›®å¡ç‰‡æœƒå‹•æ…‹æ’å…¥é€™è£¡ -->
            </div>
        </div>

        <!-- 5. çµç®—ç•«é¢ -->
        <div id="score-box" style="display: none; text-align: center;" class="fade-in">
            <h2>ğŸ‰ é—œå¡å®Œæˆï¼</h2>
            <p style="font-size: 2em; margin: 10px 0; font-weight: bold; color: var(--primary-color);">åƒè³½è€…ï¼š<span id="final-name"></span></p>
            <p style="font-size: 4em; margin: 10px 0; font-weight: bold; color: var(--accent-color);"><span id="final-score"></span> åˆ†</p>
            <div id="score-comment" style="font-size: 1.5em; margin-bottom: 25px;"></div>
            <div id="unlock-msg" style="color: var(--correct-color); font-weight: bold; display:none; margin-bottom: 15px; font-size: 1.5em;">ğŸ”“ ä¸‹ä¸€é—œå·²è§£é–ï¼</div>
            
            <div style="display: flex; justify-content: center; gap: 15px; flex-wrap: wrap;">
                <button class="btn" onclick="goToLevelScreen()">ğŸ—ºï¸ è¿”å›åœ°åœ–</button>
            </div>
        </div>

        <!-- 6. æ­·å²ç´€éŒ„ -->
        <div id="history-screen" style="display: none;" class="fade-in">
            <h2>ğŸ“œ å†’éšªè‹±é›„æ¦œ</h2>
            <ul id="history-list"></ul>
            <div style="margin-top: 30px; text-align: center;">
                <button class="btn" onclick="goToLevelScreen()">ğŸ—ºï¸ è¿”å›åœ°åœ–</button>
            </div>
        </div>
        
        <!-- 7. æ­·å²è©³ç´°å›é¡§ -->
        <div id="history-detail-screen" style="display: none;" class="fade-in">
            <h3>ğŸ“œ æ­·å²è©¦å·å›é¡§</h3>
            <p style="font-size: 1.2em; text-align: center;">æ™‚é–“ï¼š<span id="history-date"></span> | åˆ†æ•¸ï¼š<span id="history-score"></span></p>
            <ul id="history-review-list" class="review-list"></ul>
            <div style="text-align: center;">
                <button class="btn" onclick="showHistory()">â¬…ï¸ è¿”å›åˆ—è¡¨</button>
            </div>
        </div>

    </div>

    <script>
        const PREFIX = "Geography3-L5_"; // LocalStorage å‰ç¶´
        const LEVEL_CONFIG = [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 16];
        const PLAYLIST = ['sounds/bgm1.mp3', 'sounds/bgm2.mp3', 'sounds/bgm3.mp3'];

        let currentTrackIndex = 0;
        let isPlaying = false;
        
        let allQuestions = [], currentQuizQuestions = [], currentQuestionIndex = 0, score = 0;
        let userName = "", currentLevel = 1, userAnswers = {};
        let currentMode = 'level'; // level, quick, mistake, collection
        let currentAvatar = "avatar_boy1.png"; 
        
        // ç€‘å¸ƒæµæ¨¡å¼è®Šæ•¸
        let wfState = { answered: 0, correct: 0, locks: {} };

        let audioCorrect = new Audio('sounds/correct.mp3'); audioCorrect.volume = 0.4;
        let audioFail = new Audio('sounds/fail.mp3'); audioFail.volume = 0.4;
        const bgmPlayer = document.getElementById('bgm-player');
        bgmPlayer.volume = 0.3; bgmPlayer.onended = nextTrack;

        function playMusic() { if(PLAYLIST.length===0)return; bgmPlayer.src = PLAYLIST[currentTrackIndex]; bgmPlayer.play().then(()=>isPlaying=true).catch(e=>console.log("Auto-play blocked")); }
        function toggleMusic() { if (bgmPlayer.paused) { if(!bgmPlayer.src) bgmPlayer.src=PLAYLIST[currentTrackIndex]; bgmPlayer.play(); isPlaying=true; } else { bgmPlayer.pause(); isPlaying=false; } }
        function nextTrack() { currentTrackIndex = (currentTrackIndex + 1) % PLAYLIST.length; playMusic(); }

        fetch('questions.json').then(res => res.json()).then(data => { 
            allQuestions = data; 
            renderQuickLogin(); 
        }).catch(e => {
            console.error("ç„¡æ³•è¼‰å…¥ questions.json", e);
            // æ¨¡æ“¬è³‡æ–™ä¾›é è¦½æ¸¬è©¦
            allQuestions = Array.from({length: 256}, (_, i) => ({
                id: i+1,
                question: `é€™æ˜¯æ¨¡æ“¬é¡Œç›® ${i+1}ï¼šæ±åŒ—äºçš„æ°£å€™ä¸»è¦å—ä»€éº¼å½±éŸ¿ï¼Ÿ`,
                options: ["(A) å­£é¢¨", "(B) æ´‹æµ", "(C) åœ°å½¢", "(D) ç·¯åº¦"],
                answer: "(A) å­£é¢¨",
                explanation: "æ±åŒ—äºæ°£å€™æ·±å—å­£é¢¨å½±éŸ¿ï¼Œå¤å­£é«˜æº«å¤šé›¨ï¼Œå†¬å­£å¯’å†·ä¹¾ç‡¥ã€‚",
                image: ""
            }));
            renderQuickLogin();
        });

        // --- è³‡æ–™å„²å­˜ Key ç”¢ç”Ÿå™¨ ---
        function getUserKey(key) { return PREFIX + userName + '_' + key; }

        function selectAvatar(filename, element) {
            currentAvatar = filename;
            document.querySelectorAll('.avatar-option').forEach(el => el.classList.remove('selected'));
            element.classList.add('selected');
        }

        function getSavedUsers() { return JSON.parse(localStorage.getItem(PREFIX + 'savedUsers')) || []; }
        function renderQuickLogin() {
            let users = getSavedUsers();
            let container = document.getElementById('quick-login-area');
            container.innerHTML = "";
            if(users.length > 0) {
                container.innerHTML = '<div style="width:100%; text-align:center; color:#666; font-size:0.9em; margin-bottom:5px;">å¿«é€Ÿç™»å…¥</div>';
                users.forEach(userObj => {
                    let name = typeof userObj === 'string' ? userObj : userObj.name;
                    let avatar = typeof userObj === 'string' ? 'avatar_boy1.png' : userObj.avatar;
                    let div = document.createElement('div');
                    div.innerHTML = `<span class="user-tag" onclick="quickLogin('${name}', '${avatar}')"><img src="images/${avatar}" style="width:25px; height:25px; border-radius:50%; margin-right:5px;">${name}<span class="delete-user" onclick="event.stopPropagation(); deleteUser('${name}')">ğŸ—‘ï¸</span></span>`;
                    container.appendChild(div);
                });
            }
        }
        function quickLogin(name, avatar) {
            document.getElementById('username').value = name;
            currentAvatar = avatar;
            document.querySelectorAll('.avatar-option').forEach(el => {
                if(el.getAttribute('onclick').includes(avatar)) el.classList.add('selected'); else el.classList.remove('selected');
            });
            loginAndStart();
        }
        function deleteUser(name) {
            if (!confirm(`ç¢ºå®šè¦åˆªé™¤ã€Œ${name}ã€çš„æ‰€æœ‰è³‡æ–™å—ï¼Ÿ`)) return;
            localStorage.removeItem(PREFIX + name + '_mistakeBank');
            localStorage.removeItem(PREFIX + name + '_collectionBank'); // æ–°å¢
            localStorage.removeItem(PREFIX + name + '_quizHistory');
            localStorage.removeItem(PREFIX + name + '_quizProgress');
            localStorage.removeItem(PREFIX + name + '_save_level');
            localStorage.removeItem(PREFIX + name + '_save_quick');
            localStorage.removeItem(PREFIX + name + '_save_mistake');
            localStorage.removeItem(PREFIX + name + '_save_collection');

            let users = getSavedUsers();
            users = users.filter(u => (typeof u === 'string' ? u : u.name) !== name);
            localStorage.setItem(PREFIX + 'savedUsers', JSON.stringify(users));
            renderQuickLogin();
        }
        function loginAndStart() {
            const inputName = document.getElementById('username').value.trim();
            if (!inputName) { alert("è«‹å…ˆè¼¸å…¥åå­—ï¼"); return; }
            userName = inputName;
            
            let users = getSavedUsers();
            users = users.filter(u => (typeof u === 'string' ? u : u.name) !== userName);
            users.push({ name: userName, avatar: currentAvatar });
            localStorage.setItem(PREFIX + 'savedUsers', JSON.stringify(users));

            if (!isPlaying) playMusic();
            goToLevelScreen();
        }

        function getProgress() { 
            return JSON.parse(localStorage.getItem(getUserKey('quizProgress'))) || { maxLevel: 1, levelScores: {} }; 
        }
        function saveProgress(level, score) {
            let progress = getProgress();
            if (!progress.levelScores[level] || score > progress.levelScores[level]) progress.levelScores[level] = score;
            if (score >= 80 && level === progress.maxLevel && level < LEVEL_CONFIG.length) progress.maxLevel++;
            localStorage.setItem(getUserKey('quizProgress'), JSON.stringify(progress));
        }

        // --- å„€è¡¨æ¿é‚è¼¯ ---
        function goToLevelScreen() {
            document.getElementById('display-name').innerText = userName;
            document.getElementById('user-avatar-display').src = "images/" + currentAvatar;
            document.querySelectorAll('.quiz-container > div').forEach(el => el.style.display = 'none');
            document.getElementById('level-screen').style.display = 'block';
            renderLevelMap(); 
            updateBankCounts();
            checkStandardResume();
        }

        function renderLevelMap() {
            const container = document.getElementById('level-map'); 
            container.innerHTML = "";
            const progress = getProgress();
            
            LEVEL_CONFIG.forEach((_, index) => {
                let levelNum = index + 1;
                let btn = document.createElement('div');
                btn.className = 'level-btn-grid';
                
                if (levelNum <= progress.maxLevel) {
                    let bestScore = progress.levelScores[levelNum];
                    let icon = '';
                    if (bestScore === 100) icon = 'ğŸ‘‘';
                    else if (bestScore >= 80) icon = 'ğŸš©';
                    
                    if(bestScore >= 80) btn.classList.add('completed');
                    
                    btn.innerHTML = `<span>${levelNum}</span><span class="level-star">${icon}</span>`;
                    btn.onclick = () => startQuiz('level', levelNum);
                } else {
                    btn.setAttribute('disabled', 'true');
                    btn.innerHTML = `<span>${levelNum}</span><span style="font-size:0.8em">ğŸ”’</span>`;
                }
                container.appendChild(btn);
            });
        }

        function updateBankCounts() {
            let mistakes = JSON.parse(localStorage.getItem(getUserKey('mistakeBank'))) || [];
            let collections = JSON.parse(localStorage.getItem(getUserKey('collectionBank'))) || [];
            
            let mBtn = document.getElementById('btn-mistake');
            if (mistakes.length > 0) {
                mBtn.style.display = 'inline-flex';
                document.getElementById('mistake-count').innerText = mistakes.length;
            } else {
                mBtn.style.display = 'none';
            }
            document.getElementById('collection-count').innerText = collections.length;
        }

        // --- å­˜æª”èˆ‡æ¢å¾©æ©Ÿåˆ¶ ---
        function saveState(mode) {
            let data = {};
            if (mode === 'level') {
                data = { level: currentLevel, qIndex: currentQuestionIndex, score: score, answers: userAnswers, timestamp: Date.now() };
            } else {
                data = { wfState: wfState, timestamp: Date.now() }; // ç€‘å¸ƒæµåªå­˜ç‹€æ…‹
            }
            localStorage.setItem(getUserKey('save_' + mode), JSON.stringify(data));
            if (mode === 'level') checkStandardResume(); // æ›´æ–°æŒ‰éˆ•é¡¯ç¤º
        }
        
        function clearState(mode) {
            localStorage.removeItem(getUserKey('save_' + mode));
            if (mode === 'level') checkStandardResume();
        }

        function loadState(mode) {
            return JSON.parse(localStorage.getItem(getUserKey('save_' + mode)));
        }

        function checkStandardResume() {
            let save = loadState('level');
            let btn = document.getElementById('std-resume-area');
            if (save) btn.style.display = 'block'; else btn.style.display = 'none';
        }

        function resumeStandardQuiz() {
            let save = loadState('level');
            if(save) {
                startQuiz('level', save.level, true);
            }
        }

        // --- å•Ÿå‹•æ¸¬é©— ---
        function startQuiz(mode, levelNum, isResume = false) {
            currentMode = mode;
            score = 0; 
            userAnswers = {};
            
            // æ±ºå®šé¡Œåº«
            if (mode === 'level') {
                currentLevel = levelNum;
                let startIndex = 0; 
                for (let i = 0; i < levelNum - 1; i++) startIndex += LEVEL_CONFIG[i];
                let endIndex = startIndex + LEVEL_CONFIG[levelNum - 1];
                currentQuizQuestions = allQuestions.slice(startIndex, endIndex);
                
                if (isResume) {
                    let save = loadState('level');
                    currentQuestionIndex = save.qIndex;
                    score = save.score;
                    userAnswers = save.answers;
                } else {
                    currentQuestionIndex = 0;
                    clearState('level'); // æ–°é–‹å§‹å‰‡æ¸…é™¤èˆŠå­˜æª”
                }

                document.getElementById('level-title').innerText = `ğŸš© ç¬¬ ${levelNum} é—œ`;
                document.getElementById('level-screen').style.display = 'none';
                document.getElementById('quiz-content').style.display = 'block';
                document.getElementById('total-q-num').innerText = currentQuizQuestions.length;
                loadStandardQuestion();
            } 
            else {
                // ç€‘å¸ƒæµæ¨¡å¼ (Quick, Mistake, Collection)
                let ids = [];
                let title = "";
                let headerClass = "";
                
                if (mode === 'quick') {
                    currentQuizQuestions = [...allQuestions]; // å…¨ç¯„åœ
                    title = "ğŸš€ æ¥µé€Ÿåˆ·é¡Œ (å…¨ç¯„åœ)";
                    headerClass = "purple";
                } else if (mode === 'mistake') {
                    ids = JSON.parse(localStorage.getItem(getUserKey('mistakeBank'))) || [];
                    currentQuizQuestions = allQuestions.filter(q => ids.includes(q.id));
                    title = "ğŸ“• éŒ¯é¡ŒæŒ‘æˆ°";
                } else if (mode === 'collection') {
                    ids = JSON.parse(localStorage.getItem(getUserKey('collectionBank'))) || [];
                    currentQuizQuestions = allQuestions.filter(q => ids.includes(q.id));
                    title = "â­ é‡é»æ”¶è—";
                }

                if (currentQuizQuestions.length === 0) { alert("ç›®å‰æ²’æœ‰é¡Œç›®å–”ï¼"); return; }
                
                // æª¢æŸ¥å­˜æª”
                let save = loadState(mode);
                if (save && confirm("ç™¼ç¾ä¸Šæ¬¡æœªå®Œæˆçš„é€²åº¦ï¼Œæ˜¯å¦ç¹¼çºŒï¼Ÿ")) {
                    wfState = save.wfState;
                } else {
                    wfState = { answered: 0, correct: 0, locks: {} };
                    clearState(mode);
                }

                renderWaterfallQuiz(title, headerClass);
            }
        }

        // --- æ¨™æº–æ¨¡å¼é‚è¼¯ ---
        function loadStandardQuestion() {
            const currentQuestion = currentQuizQuestions[currentQuestionIndex];
            let qContainer = document.getElementById('question-container');
            qContainer.classList.remove('fade-in'); void qContainer.offsetWidth; qContainer.classList.add('fade-in');
            
            let progress = ((currentQuestionIndex) / currentQuizQuestions.length) * 100;
            document.getElementById('progress-bar').style.width = progress + "%";
            document.getElementById('current-q-num').innerText = currentQuestionIndex + 1;
            document.getElementById('question-text').innerText = currentQuestion.question;
            document.getElementById('explanation').style.display = 'none'; 
            document.getElementById('next-btn').style.display = 'none';
            
            const imgElement = document.getElementById('question-image');
            if (currentQuestion.image) { imgElement.src = currentQuestion.image; imgElement.style.display = 'block'; } else { imgElement.style.display = 'none'; }
            
            // æ„›å¿ƒç‹€æ…‹
            updateFavBtnState(currentQuestion.id);

            const optionsList = document.getElementById('options-list'); optionsList.innerHTML = '';
            currentQuestion.options.forEach(option => {
                const li = document.createElement('li'); const button = document.createElement('button');
                button.className = 'option-btn'; button.innerText = option;
                button.onclick = () => checkStandardAnswer(button, option, currentQuestion);
                li.appendChild(button); optionsList.appendChild(li);
            });
            
            saveState('level'); // è‡ªå‹•å­˜æª”
        }

        function checkStandardAnswer(btn, selectedOption, questionData) {
            const buttons = document.querySelectorAll('.option-btn'); buttons.forEach(button => button.disabled = true); 
            userAnswers[questionData.id] = selectedOption;
            const selectedCode = selectedOption.substring(0, 3); const correctCode = questionData.answer.substring(0, 3);
            
            if (selectedCode === correctCode) {
                btn.classList.add('correct'); score++; audioCorrect.play().catch(()=>{});
                confetti({ particleCount: 50, spread: 50, origin: { y: 0.7 } });
            } else {
                btn.classList.add('wrong'); audioFail.play().catch(()=>{});
                buttons.forEach(button => { if (button.innerText.substring(0, 3) === correctCode) button.classList.add('correct'); });
                addToBank('mistake', questionData.id);
            }
            document.getElementById('explanation-text').innerText = questionData.explanation || "æš«ç„¡è§£æ";
            document.getElementById('explanation').style.display = 'block';
            document.getElementById('next-btn').style.display = 'block';
            
            saveState('level'); // æ›´æ–°å­˜æª”
        }

        function nextQuestion() {
            currentQuestionIndex++;
            if (currentQuestionIndex < currentQuizQuestions.length) loadStandardQuestion(); else setTimeout(showResult, 500);
        }

        function exitQuiz() {
            saveState('level'); // ç¢ºä¿é›¢é–‹å‰å­˜æª”
            if(confirm("é€²åº¦å·²ä¿å­˜ï¼Œç¢ºå®šè¦è¿”å›åœ°åœ–å—ï¼Ÿ")) goToLevelScreen();
        }

        // --- ç€‘å¸ƒæµæ¨¡å¼é‚è¼¯ ---
        function renderWaterfallQuiz(title, headerClass) {
            document.getElementById('level-screen').style.display = 'none';
            document.getElementById('waterfall-screen').style.display = 'block';
            
            document.getElementById('wf-title').innerText = title;
            document.getElementById('wf-header').className = "sticky-header " + headerClass;
            updateWFScoreBoard();

            let container = document.getElementById('waterfall-container');
            container.innerHTML = "";

            currentQuizQuestions.forEach((q, idx) => {
                let card = document.createElement('div');
                card.className = "quiz-card";
                card.id = `wf-card-${q.id}`;
                
                // æª¢æŸ¥æ˜¯å¦å·²é–å®š
                let lockState = wfState.locks[q.id]; // 'correct' or 'wrong'
                if (lockState) card.classList.add(lockState === 'correct' ? 'answered-correct' : 'answered-wrong');

                let isFav = checkInBank('collection', q.id);
                let trashHtml = (currentMode === 'mistake' || currentMode === 'collection') 
                    ? `<button class="icon-btn icon-trash" onclick="deleteItemInWF(${q.id}, this)">ğŸ—‘ï¸</button>` : '';

                let imgHtml = q.image ? `<img src="${q.image}" class="card-img" style="display:block">` : '';
                
                // é¸é …ç”¢ç”Ÿ
                let optionsHtml = q.options.map(opt => {
                    let optClass = "wf-option";
                    let disabled = lockState ? "disabled" : "";
                    
                    // æ¢å¾©é¸é …ç‹€æ…‹
                    if (lockState) {
                        if (opt.startsWith(q.answer.substring(0, 3))) optClass += " correct-ans"; // æ­£ç¢ºç­”æ¡ˆ
                        if (lockState === 'wrong' && wfState.locks[q.id + '_sel'] === opt) optClass += " wrong-sel"; // èª¤é¸
                        if (lockState === 'correct' && wfState.locks[q.id + '_sel'] === opt) optClass += " correct-sel"; // æ­£é¸
                    }

                    return `<div class="${optClass} ${disabled}" onclick="checkWFAnswer(${q.id}, '${opt}', this)">${opt}</div>`;
                }).join('');

                let explanationStyle = lockState ? "display:block" : "";

                card.innerHTML = `
                    <div class="card-header">
                        <div class="card-question">${q.question}</div>
                        <div class="card-actions">
                            ${trashHtml}
                            <button class="icon-btn icon-heart ${isFav?'active':''}" onclick="toggleWFFav(${q.id}, this)">â¤</button>
                        </div>
                    </div>
                    ${imgHtml}
                    <div class="wf-options" id="wf-opts-${q.id}">${optionsHtml}</div>
                    <div class="wf-explanation" id="wf-exp-${q.id}" style="${explanationStyle}">
                        <strong>ğŸ’¡ è§£æï¼š</strong> ${q.explanation || "æš«ç„¡è§£æ"}
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function checkWFAnswer(qId, selectedOption, optEl) {
            if (wfState.locks[qId]) return; // å·²é–å®š

            let qData = currentQuizQuestions.find(q => q.id === qId);
            let isCorrect = selectedOption.startsWith(qData.answer.substring(0, 3));
            
            // æ›´æ–°ç‹€æ…‹
            wfState.locks[qId] = isCorrect ? 'correct' : 'wrong';
            wfState.locks[qId + '_sel'] = selectedOption;
            wfState.answered++;
            if (isCorrect) wfState.correct++;

            // UI æ›´æ–°
            let card = document.getElementById(`wf-card-${qId}`);
            card.classList.add(isCorrect ? 'answered-correct' : 'answered-wrong');
            
            let opts = document.getElementById(`wf-opts-${qId}`).children;
            Array.from(opts).forEach(div => {
                div.classList.add('disabled');
                if (div.innerText.startsWith(qData.answer.substring(0, 3))) div.classList.add('correct-ans');
                if (div === optEl) div.classList.add(isCorrect ? 'correct-sel' : 'wrong-sel');
            });

            document.getElementById(`wf-exp-${qId}`).style.display = 'block';

            // éŸ³æ•ˆèˆ‡é‚è¼¯
            if (isCorrect) {
                audioCorrect.play().catch(()=>{});
                // æ³¨æ„ï¼šé€™è£¡ä¸åˆªé™¤éŒ¯é¡Œæœ¬ä¸­çš„é …ç›®ï¼Œæ”¹ç‚ºæ‰‹å‹•åˆªé™¤
            } else {
                audioFail.play().catch(()=>{});
                addToBank('mistake', qId); // ç­”éŒ¯è‡ªå‹•åŠ å…¥éŒ¯é¡Œ
            }

            updateWFScoreBoard();
            saveState(currentMode);
        }

        function updateWFScoreBoard() {
            document.getElementById('wf-correct-count').innerText = wfState.correct;
            document.getElementById('wf-total-count').innerText = currentQuizQuestions.length;
        }

        function toggleWFFav(qId, btn) {
            toggleBank('collection', qId);
            btn.classList.toggle('active');
        }

        function deleteItemInWF(qId, btn) {
            // é›™é‡ç¢ºèª
            if (!confirm("ç¢ºå®šè¦å¾æ­¤æ¸…å–®ä¸­ç§»é™¤é€™é¡Œå—ï¼Ÿ")) return;
            if (!confirm("âš ï¸ è«‹å†æ¬¡ç¢ºèªï¼šçœŸçš„è¦ç§»é™¤å—ï¼Ÿ")) return;

            // åŸ·è¡Œåˆªé™¤
            if (currentMode === 'mistake') removeFromBank('mistake', qId);
            if (currentMode === 'collection') removeFromBank('collection', qId);

            // UI ç§»é™¤
            let card = document.getElementById(`wf-card-${qId}`);
            card.style.opacity = '0';
            setTimeout(() => card.remove(), 300);
            
            // å¾ç•¶å‰ä½‡åˆ—ç§»é™¤ï¼Œé¿å…è¨ˆåˆ†éŒ¯èª¤
            // (é¸æ“‡æ€§ï¼šå¦‚æœè¦ä¿ç•™è¨ˆåˆ†æ¿ç¸½æ•¸ä¸è®Šï¼Œå°±ä¸æ‰£æ¸›ï¼›é€™è£¡é¸æ“‡ä¿ç•™ç¸½æ•¸ï¼Œä½†æ¨™è¨˜å·²ç§»é™¤)
        }

        function exitWaterfall() {
            saveState(currentMode); // é›¢é–‹å­˜æª”
            if(confirm("é€²åº¦å·²ä¿å­˜ï¼Œè¦è¿”å›åœ°åœ–å—ï¼Ÿ")) {
                document.getElementById('waterfall-screen').style.display = 'none';
                goToLevelScreen();
            }
        }

        // --- çµç®—èˆ‡é€šç”¨åŠŸèƒ½ ---
        function showResult() {
            document.getElementById('quiz-content').style.display = 'none';
            document.getElementById('score-box').style.display = 'block';
            let finalScore = Math.round((score / currentQuizQuestions.length) * 100);
            document.getElementById('final-score').innerText = finalScore;
            document.getElementById('final-name').innerText = userName;
            
            let comment = "";
            if(finalScore === 100) comment = "ğŸ† å®Œç¾é€šé—œï¼å¤ªå¼·äº†ï¼"; 
            else if(finalScore >= 90) comment = "ğŸŒŸ å„ªç§€ï¼ç¹¼çºŒä¿æŒï¼"; 
            else if(finalScore >= 80) comment = "ğŸ‰ æ­å–œéé—œï¼ä¸‹ä¸€é—œè§£é–ï¼"; 
            else comment = "ğŸ’ª åŠ æ²¹ï¼80åˆ†æ‰èƒ½è§£é–ä¸‹ä¸€é—œå–”ï¼";
            document.getElementById('score-comment').innerText = comment;

            if (currentMode === 'level') {
                saveProgress(currentLevel, finalScore);
                saveHistory(userName, finalScore, currentQuizQuestions, userAnswers, `ç¬¬ ${currentLevel} é—œ`);
                clearState('level'); // å®Œæˆå¾Œæ¸…é™¤é€²åº¦
                
                if (finalScore >= 80 && currentLevel < LEVEL_CONFIG.length) {
                    document.getElementById('unlock-msg').style.display = 'block';
                } else document.getElementById('unlock-msg').style.display = 'none';
            }
        }

        // --- æ”¶è—èˆ‡éŒ¯é¡Œæœ¬é‚è¼¯ ---
        function getBank(type) { return JSON.parse(localStorage.getItem(getUserKey(type + 'Bank'))) || []; }
        function saveBank(type, list) { localStorage.setItem(getUserKey(type + 'Bank'), JSON.stringify(list)); }
        
        function checkInBank(type, id) { return getBank(type).includes(id); }
        
        function addToBank(type, id) {
            let list = getBank(type);
            if (!list.includes(id)) { list.push(id); saveBank(type, list); }
        }
        function removeFromBank(type, id) {
            let list = getBank(type);
            list = list.filter(itemId => itemId !== id);
            saveBank(type, list);
        }
        function toggleBank(type, id) {
            if (checkInBank(type, id)) removeFromBank(type, id); else addToBank(type, id);
        }

        // æ¨™æº–æ¨¡å¼ä¸‹çš„æ„›å¿ƒæŒ‰éˆ•
        function updateFavBtnState(id) {
            let btn = document.getElementById('std-fav-btn');
            if (checkInBank('collection', id)) btn.classList.add('active'); else btn.classList.remove('active');
        }
        function toggleFavoriteCurrent() {
            let id = currentQuizQuestions[currentQuestionIndex].id;
            toggleBank('collection', id);
            updateFavBtnState(id);
        }

        // --- æ­·å²ç´€éŒ„é‚è¼¯ ---
        function saveHistory(name, score, questionsData, answersData, modeName) {
            let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || [];
            let record = { id: Date.now(), name: name, score: score, date: new Date().toLocaleString(), mode: modeName, answers: answersData, questionIds: questionsData.map(q => q.id) };
            history.push(record); localStorage.setItem(getUserKey('quizHistory'), JSON.stringify(history));
        }
        function showHistory() {
            document.querySelectorAll('.quiz-container > div').forEach(el => el.style.display = 'none');
            document.getElementById('history-screen').style.display = 'block';
            let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || [];
            let list = document.getElementById('history-list'); list.innerHTML = "";
            if(history.length === 0) list.innerHTML = "<li style='justify-content:center'>æš«ç„¡ç´€éŒ„</li>";
            else {
                history.reverse().forEach(rec => {
                    let li = document.createElement('li');
                    li.innerHTML = `<div style="background:white; padding:15px; border-radius:10px; border:1px solid #eee; margin-bottom:10px; display:flex; justify-content:space-between; align-items:center;">
                        <div><strong>${rec.mode}</strong> - <span style="color:${rec.score>=80?'#27AE60':'#C0392B'}">${rec.score}åˆ†</span><br><small style="color:gray">${rec.date}</small></div>
                        <div><button class="btn btn-green btn-sm" onclick="replayHistory(${rec.id})">å›æ”¾</button></div>
                    </div>`;
                    list.appendChild(li);
                });
            }
        }
        function replayHistory(recordId) {
            let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || [];
            let record = history.find(r => r.id === recordId);
            if (!record) return;
            document.getElementById('history-screen').style.display = 'none';
            document.getElementById('history-detail-screen').style.display = 'block';
            document.getElementById('history-date').innerText = record.date;
            document.getElementById('history-score').innerText = record.score;
            let examQuestions = allQuestions.filter(q => record.questionIds.includes(q.id));
            let list = document.getElementById('history-review-list'); list.innerHTML = "";
            
            examQuestions.forEach((q, index) => {
                let userAns = record.answers[q.id];
                let correctAns = q.answer;
                let isRight = (userAns && userAns.substring(0,3) === correctAns.substring(0,3));
                let tagClass = isRight ? "tag-correct" : "tag-wrong";
                list.innerHTML += `<li class="review-item" style="padding:15px; border-radius:10px;">
                    <div style="font-weight:bold; margin-bottom:10px;"><span class="tag ${tagClass}">${isRight?"ç­”å°":"ç­”éŒ¯"}</span> ${index+1}. ${q.question}</div>
                    <div style="font-size:0.9em; color:#555;">ä½ çš„ç­”æ¡ˆï¼š${userAns || "æœªä½œç­”"} <br> æ­£ç¢ºç­”æ¡ˆï¼š<span style="color:#27AE60; font-weight:bold;">${correctAns}</span></div>
                    <div style="margin-top:5px; background:#f0f0f0; padding:8px; border-radius:5px; font-size:0.9em;">ğŸ’¡ ${q.explanation || "ç„¡è§£æ"}</div>
                </li>`;
            });
        }

        function logout() { location.reload(); }
    </script>
</body>
</html>