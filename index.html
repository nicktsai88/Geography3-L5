<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ç†ç¬¬3å†Š æ±åŒ—äºçš„è‡ªç„¶ç’°å¢ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=CwTeXYen:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #FF8C42; 
            --secondary-color: #F9F871; 
            --bg-color: #FFF5E1; 
            --text-color: #4A4A4A;
            --accent-color: #FF5E5E; 
            --correct-color: #2ECC71;
            --wrong-color: #E74C3C;
            --locked-color: #BDC3C7;
            --music-btn-color: #3498db;
            --gold-color: #f1c40f;
            --purple-color: #9b59b6;
        }

        body { 
            font-family: 'CwTeXYen', "Microsoft JhengHei", Arial, sans-serif; 
            max-width: 900px; margin: 0 auto; padding: 20px; 
            background-color: var(--bg-color); color: var(--text-color);
            background-image: radial-gradient(#FFD166 2px, transparent 2px);
            background-size: 30px 30px; min-height: 100vh;
        }

        h1 { font-size: 2.5em; color: #D35400; text-align: center; margin-top: 0; text-shadow: 2px 2px 0px white; }
        h2, h3 { color: #D35400; text-align: center; }

        /* --- ä¸»è¦å®¹å™¨ --- */
        .quiz-container { 
            background: rgba(255, 255, 255, 0.95); padding: 30px; 
            border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); 
            border: 4px solid var(--primary-color); position: relative; 
            overflow: hidden; min-height: 500px;
        }

        /* --- å‹•ç•«ç‰¹æ•ˆ --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }
        .pop-anim { animation: pop 0.3s; }
        @keyframes shake { 0% { transform: rotate(0deg); } 25% { transform: rotate(5deg); } 75% { transform: rotate(-5deg); } 100% { transform: rotate(0deg); } }

        /* --- æŒ‰éˆ•æ¨£å¼ --- */
        .btn {
            background-color: var(--primary-color); color: white; border: none;
            padding: 10px 20px; font-size: 1.2em; border-radius: 50px;
            cursor: pointer; transition: 0.3s; box-shadow: 0 5px 0 #E67E22;
            font-family: inherit; font-weight: bold; margin: 5px; display: inline-block;
        }
        .btn:hover { transform: translateY(-3px); }
        .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-green { background-color: var(--correct-color); box-shadow: 0 5px 0 #27AE60; }
        .btn-red { background-color: var(--accent-color); box-shadow: 0 5px 0 #C0392B; }
        .btn-gray { background-color: #95a5a6; box-shadow: 0 5px 0 #7f8c8d; }
        .btn-blue { background-color: #3498db; box-shadow: 0 5px 0 #2980b9; }
        .btn-gold { background-color: var(--gold-color); box-shadow: 0 5px 0 #d4ac0d; color: #fff; text-shadow: 1px 1px 0 #b7950b; }
        .btn-purple { background-color: var(--purple-color); box-shadow: 0 5px 0 #8e44ad; }
        
        .btn-sm { padding: 6px 12px; font-size: 1em; margin: 0 2px; box-shadow: 0 3px 0 rgba(0,0,0,0.2); }
        .btn-music { background-color: var(--music-btn-color); box-shadow: 0 3px 0 #2980b9; }

        /* --- è¼¸å…¥æ¡†èˆ‡å¿«é€Ÿç™»å…¥ --- */
        input[type="text"] {
            padding: 12px; font-size: 1.5em; border: 3px solid var(--primary-color);
            border-radius: 15px; margin: 15px; font-family: inherit; text-align: center; width: 80%;
        }
        .quick-login-area { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .user-tag {
            background: #FFF0D4; border: 2px solid var(--primary-color); padding: 8px 15px;
            border-radius: 20px; cursor: pointer; font-size: 1.1em; transition: 0.2s;
            color: #D35400; display: flex; align-items: center; gap: 8px;
        }
        .user-tag:hover { background: var(--primary-color); color: white; }
        .delete-user { font-size: 0.9em; cursor: pointer; padding: 2px 6px; border-radius: 50%; background: rgba(255,255,255,0.5); }
        
        /* --- è§’è‰²é¸æ“‡ --- */
        .avatar-selection { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .avatar-option { width: 80px; height: 80px; border-radius: 50%; border: 4px solid transparent; cursor: pointer; object-fit: cover; background: white; }
        .avatar-option.selected { border-color: var(--correct-color); box-shadow: 0 0 15px var(--correct-color); transform: scale(1.1); }

        /* --- é—œå¡åœ°åœ– --- */
        #level-screen {
            background-image: url('images/map_bg.jpg'); background-size: cover; background-position: center;
            border-radius: 15px; padding: 20px; min-height: 400px; position: relative;
            overflow: hidden; /* é˜²æ­¢è£é£¾å“æº¢å‡º */
        }
        /* åœ°åœ–è£é£¾å“ */
        .map-decoration {
            position: absolute; font-size: 2.5em; z-index: 1; cursor: pointer;
            filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.3));
            transition: transform 0.2s;
        }
        .map-decoration:hover { transform: scale(1.2); }
        /* è£é£¾æ¨¡å¼é®ç½© */
        #decoration-overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.1); z-index: 5; cursor: crosshair;
            display: none; border: 4px dashed var(--purple-color); box-sizing: border-box; border-radius: 15px;
        }
        
        /* é ‚éƒ¨è³‡è¨Šåˆ— */
        .status-bar {
            display: flex; justify-content: space-between; align-items: center;
            background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 15px; margin-bottom: 20px;
            box-shadow: 0 4px 10px rgba(0,0,0,0.1); position: relative; z-index: 20;
        }
        .status-item { display: flex; align-items: center; gap: 10px; font-size: 1.1em; font-weight: bold; color: #555; }
        .rank-img { width: 50px; height: 50px; object-fit: contain; filter: drop-shadow(2px 2px 2px rgba(0,0,0,0.2)); }
        .coin-icon { width: 30px; height: 30px; vertical-align: middle; }
        
        /* Så‹åœ°åœ– */
        .level-map-container { display: flex; flex-direction: column; align-items: center; gap: 10px; position: relative; z-index: 10; }
        .level-row { display: flex; justify-content: center; align-items: center; gap: 15px; }
        .level-row.reverse { flex-direction: row-reverse; }
        .level-wrapper { display: flex; align-items: center; position: relative; }
        .map-avatar {
            position: absolute; top: -60px; left: 50%; transform: translateX(-50%);
            width: 60px; height: 60px; z-index: 10; animation: float 2s infinite ease-in-out;
            filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3));
        }
        @keyframes float { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -10px); } }
        .level-btn {
            background-color: white; border: 4px solid var(--primary-color); border-radius: 50%;
            width: 100px; height: 100px; font-size: 1.1em; cursor: pointer; color: var(--primary-color);
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            box-shadow: 0 5px 10px rgba(0,0,0,0.2); position: relative; z-index: 2;
        }
        .level-btn:disabled { background-color: #e0e0e0; border-color: var(--locked-color); color: var(--locked-color); }
        .arrow-icon { font-size: 2.5em; color: var(--primary-color); margin: 0 5px; text-shadow: 2px 2px 0 white; display: block; }
        .arrow-right { animation: bounceRight 2s infinite; }
        .arrow-left { animation: bounceLeft 2s infinite; transform: scaleX(-1); }
        .arrow-down { animation: bounceDown 2s infinite; font-size: 3em; line-height: 0.5; margin: -5px 0; }
        .row-connector { width: 100%; display: flex; height: 40px; align-items: center; justify-content: flex-end; padding-right: 50px; }
        .row-connector.left { justify-content: flex-start; padding-left: 50px; padding-right: 0; }

        @keyframes bounceRight { 0%, 100% { transform: translateX(0); } 50% { transform: translateX(5px); } }
        @keyframes bounceLeft { 0%, 100% { transform: translateX(0) scaleX(-1); } 50% { transform: translateX(-5px) scaleX(-1); } }
        @keyframes bounceDown { 0%, 100% { transform: translateY(0); } 50% { transform: translateY(5px); } }

        @media (max-width: 600px) {
            .level-row, .level-row.reverse { flex-direction: column; gap: 0; }
            .level-wrapper { flex-direction: column; margin-bottom: 10px; }
            .arrow-right, .arrow-left, .row-connector { display: none; }
            .level-wrapper::after { content: 'â¬‡'; font-size: 2.5em; color: var(--primary-color); display: block; margin: 5px 0; animation: bounceDown 2s infinite; }
            .level-wrapper:last-child::after { display: none; }
            .map-avatar { top: 20px; left: -60px; transform: none; }
        }

        /* --- æ¸¬é©—ç•«é¢ --- */
        .quiz-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
        .timer-bar-container { width: 100%; height: 10px; background: #ddd; border-radius: 5px; overflow: hidden; margin-bottom: 15px; }
        .timer-bar { height: 100%; background: var(--wrong-color); width: 100%; transition: width 1s linear; }
        
        .combo-text { position: absolute; top: 50px; right: 20px; font-size: 2em; color: #ffcc00; font-weight: bold; text-shadow: 2px 2px 0 red; transform: rotate(-10deg); animation: pop 0.3s; display: none; z-index: 100; }
        .question-box { background-color: #FFF9F0; border-left: 8px solid var(--accent-color); padding: 20px; margin-bottom: 20px; border-radius: 15px; }
        .question-text { font-size: 1.8em; font-weight: 600; line-height: 1.6; }
        .question-img { max-width: 100%; max-height: 220px; width: auto; object-fit: contain; display: block; margin: 15px auto; border-radius: 15px; }
        .option-btn { width: 100%; padding: 15px; margin: 10px 0; text-align: left; background: white; border: 3px solid #FFE4B5; border-radius: 20px; cursor: pointer; font-size: 1.5em; }
        .option-btn:hover { background-color: #FFF0D4; border-color: var(--primary-color); }
        .correct { background-color: #D4EDDA !important; border-color: var(--correct-color) !important; }
        .wrong { background-color: #F8D7DA !important; border-color: var(--wrong-color) !important; opacity: 0.6; }
        
        .powerups-bar { display: flex; justify-content: center; gap: 15px; margin-top: 20px; }
        .powerup-btn { background: white; border: 2px solid #ccc; border-radius: 15px; width: 70px; height: 70px; cursor: pointer; position: relative; display: flex; align-items: center; justify-content: center; }
        .powerup-btn img { width: 40px; height: 40px; object-fit: contain; }
        .powerup-btn:hover { border-color: var(--gold-color); background: #fffbe6; }
        .powerup-btn:disabled { opacity: 0.5; cursor: not-allowed; filter: grayscale(100%); }
        .powerup-count { position: absolute; bottom: -5px; right: -5px; background: var(--red); color: white; font-size: 0.8em; padding: 2px 6px; border-radius: 10px; background: #E74C3C; }

        /* --- å½ˆçª— (é€šç”¨) --- */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; animation: fadeIn 0.3s; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; max-width: 90%; max-height: 90%; text-align: center; position: relative; overflow-y: auto; }
        .modal-close { position: absolute; top: 10px; right: 10px; background: #eee; border: none; width: 30px; height: 30px; border-radius: 50%; cursor: pointer; }

        /* å•†åº—èˆ‡æ‰­è›‹ */
        .shop-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 15px; }
        .shop-item { border: 2px solid #eee; padding: 15px; border-radius: 10px; text-align: center; transition: 0.2s; }
        .shop-item:hover { border-color: var(--gold-color); transform: translateY(-5px); }
        .shop-item img { width: 60px; height: 60px; object-fit: contain; margin-bottom: 10px; }
        .shop-price { color: var(--gold-color); font-weight: bold; font-size: 1.2em; }
        
        .gacha-box { border: 4px solid var(--purple-color); border-radius: 15px; padding: 20px; background: #f3e5f5; margin-top: 20px; }
        .gacha-anim { font-size: 5em; animation: shake 0.5s infinite; display:none; }
        .gacha-result { font-size: 3em; animation: pop 0.5s; display:none; }

        /* è£é£¾å·¥å…·åˆ— */
        #decoration-toolbar {
            position: fixed; bottom: 0; left: 0; width: 100%; background: white;
            padding: 15px; box-shadow: 0 -5px 15px rgba(0,0,0,0.1);
            display: none; z-index: 3000; flex-direction: column; align-items: center;
        }
        .souvenir-list { display: flex; gap: 10px; overflow-x: auto; width: 100%; padding-bottom: 10px; }
        .souvenir-item { font-size: 2em; cursor: pointer; padding: 5px; border: 2px solid transparent; border-radius: 5px; }
        .souvenir-item:hover, .souvenir-item.selected { background: #eee; border-color: var(--purple-color); }
        .souvenir-item.locked { opacity: 0.3; filter: grayscale(1); cursor: not-allowed; }

        /* æˆå°± */
        .achievement-list { text-align: left; }
        .achievement-item { display: flex; align-items: center; padding: 15px; border-bottom: 1px solid #eee; gap: 15px; opacity: 0.5; filter: grayscale(1); transition: 0.3s; }
        .achievement-item.unlocked { opacity: 1; filter: none; background: #f9fbe7; border-radius: 10px; }
        .ach-icon { width: 60px; height: 60px; object-fit: contain; }
        
        /* åœ–é‘‘ */
        .collection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 20px; }
        .card-item { aspect-ratio: 2/3; border-radius: 10px; overflow: hidden; box-shadow: 0 4px 8px rgba(0,0,0,0.2); position: relative; }
        .card-item.locked { filter: grayscale(1) opacity(0.7); }
        .card-img { width: 100%; height: 100%; object-fit: cover; }
        .card-overlay { position: absolute; top:0; left:0; width:100%; height:100%; background: rgba(255,255,255,0.5); display:flex; align-items:center; justify-content:center; font-size:3em; }

        /* GIF çå‹µ */
        .reward-content { background: transparent; box-shadow: none; }
        .reward-gif { max-width: 80vw; max-height: 60vh; border-radius: 20px; border: 5px solid white; }
        .reward-text { font-size: 2.5em; color: #fff; text-shadow: 2px 2px 0 #000; margin-top: 10px; animation: pop 1s infinite; }

    </style>
</head>
<body>

    <div class="quiz-container">
        <audio id="bgm-player"></audio>

        <div id="welcome-screen" class="fade-in">
            <h1>åœ°ç†ç¬¬3å†Š æ±åŒ—äºçš„è‡ªç„¶ç’°å¢ƒ</h1>
            <div style="font-size: 4em; margin: 20px;">ğŸŒâœ¨ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡·</div>
            <p style="font-size: 1.5em;">è«‹è¼¸å…¥ä½ çš„åå­—ä¸¦é¸æ“‡ä¸€ä½å†’éšªå¤¥ä¼´ï¼</p>
            <input type="text" id="username" placeholder="ä½ çš„åå­—æ˜¯..." />
            
            <div class="avatar-selection">
                <img src="images/avatar_boy1.png" class="avatar-option selected" onclick="selectAvatar('avatar_boy1.png', this)">
                <img src="images/avatar_boy2.png" class="avatar-option" onclick="selectAvatar('avatar_boy2.png', this)">
                <img src="images/avatar_girl1.png" class="avatar-option" onclick="selectAvatar('avatar_girl1.png', this)">
                <img src="images/avatar_girl2.png" class="avatar-option" onclick="selectAvatar('avatar_girl2.png', this)">
            </div>
            <div id="quick-login-area" class="quick-login-area"></div>
            
            <div id="daily-reward-msg" style="display:none; background:#fff3cd; padding:10px; margin:10px; border-radius:10px; border:2px solid #ffc107;">
                ğŸ“… æ¯æ—¥ç°½åˆ°æˆåŠŸï¼ç²å¾— 50 é‡‘å¹£ï¼ğŸ’°
            </div>

            <button class="btn" onclick="loginAndStart()">ğŸ‘‰ é€²å…¥é—œå¡åœ°åœ–</button>
        </div>

        <div id="level-screen" style="display: none;" class="fade-in">
            <div class="status-bar">
                <div class="status-item">
                    <img id="user-avatar-display" src="" style="width:50px; height:50px; border-radius:50%; object-fit:cover; border:2px solid var(--primary-color);">
                    <div>
                        <div style="display:flex; align-items:center; gap:5px;">
                            <span id="display-name"></span>
                            <img id="rank-icon" src="images/rank_1.png" class="rank-img" title="ç¨±è™Ÿ">
                        </div>
                    </div>
                </div>
                <div class="status-item" style="color:var(--gold-color);">
                    <img src="images/coin.png" class="coin-icon"> <span id="user-gold">0</span>
                </div>
            </div>

            <div id="level-map" class="level-map-container">
                <div id="decoration-overlay" onclick="placeDecorationOnMap(event)"></div>
            </div>
            
            <div style="margin-top: 20px; background: rgba(255,255,255,0.9); padding:10px; border-radius:15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                <button class="btn btn-purple" onclick="toggleDecorationMode()">ğŸ¨ è£é£¾åœ°åœ–</button>
                <button class="btn btn-gold" onclick="openShop()">ğŸª å•†åº—/æ‰­è›‹</button>
                <button class="btn btn-blue" onclick="showCollection()">ğŸ´ åœ–é‘‘</button>
                <button class="btn btn-red" onclick="openAchievements()">ğŸ… æˆå°±</button>
                <button class="btn btn-green" onclick="showHistory()">ğŸ“œ ç´€éŒ„</button>
                <button id="btn-mistake" class="btn btn-gray" onclick="startQuiz('mistake')" style="display:none;">ğŸ“• éŒ¯é¡Œ</button>
                
                <div style="display:inline-flex; gap:5px; align-items:center; background:#eee; padding:5px; border-radius:30px;">
                    <button class="btn btn-sm btn-music" onclick="toggleMusic()">â¯ï¸</button>
                    <button class="btn btn-sm btn-music" onclick="nextTrack()">â­ï¸</button>
                </div>
                <button class="btn btn-gray" onclick="logout()">ğŸšª ç™»å‡º</button>
            </div>
        </div>

        <div id="decoration-toolbar">
            <p style="margin:0 0 10px 0; font-weight:bold;">ğŸ‘‡ é¸æ“‡ç´€å¿µå“è²¼ç´™ (é»æ“Šåœ°åœ–ç©ºç™½è™•è²¼ä¸Š)</p>
            <div id="souvenir-list" class="souvenir-list"></div>
            <button class="btn btn-sm btn-gray" onclick="toggleDecorationMode()">å®Œæˆè£é£¾</button>
        </div>

        <div id="quiz-content" style="display: none;" class="fade-in">
            <div class="quiz-header">
                <h3 id="level-title" style="margin:0;">ç¬¬ X é—œ</h3>
                <div class="header-controls">
                    <button class="btn btn-sm btn-music" onclick="toggleMusic()">â¯ï¸</button>
                    <button class="btn btn-gray btn-sm" onclick="exitQuiz()">ğŸ  å›åˆ°åœ°åœ–</button>
                </div>
            </div>
            
            <div style="display:flex; justify-content:space-between; margin-bottom:5px; font-size:0.9em; color:gray;">
                <span>â³ é™æ™‚æŒ‘æˆ°</span>
                <span>é¡Œè™Ÿ: <span id="current-q-num">1</span> / <span id="total-q-num">20</span></span>
            </div>
            <div class="timer-bar-container"><div id="timer-bar" class="timer-bar"></div></div>
            <div id="combo-display" class="combo-text">COMBO x2!</div>

            <div id="question-container" class="fade-in">
                <div class="question-box">
                    <div id="question-text" class="question-text">è¼‰å…¥ä¸­...</div>
                    <img id="question-image" class="question-img" style="display: none;" />
                </div>
                <ul id="options-list" style="list-style: none; padding: 0;"></ul>
            </div>
            
            <div class="powerups-bar">
                <button class="powerup-btn" id="btn-use-fifty" onclick="usePowerUp('fifty')">
                    <img src="images/item_5050.png"> <span class="powerup-count" id="count-fifty">0</span>
                </button>
                <button class="powerup-btn" id="btn-use-hint" onclick="usePowerUp('hint')">
                    <img src="images/item_hint.png"> <span class="powerup-count" id="count-hint">0</span>
                </button>
                <button class="powerup-btn" id="btn-use-skip" onclick="usePowerUp('skip')">
                    <img src="images/item_skip.png"> <span class="powerup-count" id="count-skip">0</span>
                </button>
            </div>

            <div id="explanation" class="explanation-box" style="display: none;">
                <strong>ğŸ’¡ è§£æï¼š</strong> <span id="explanation-text"></span>
            </div>
            <button id="next-btn" class="btn" style="display: none; width: 100%; margin-top: 25px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡ï¸</button>
        </div>

        <div id="score-box" style="display: none; text-align: center;" class="fade-in">
            <h2>ğŸ‰ é—œå¡å®Œæˆï¼</h2>
            <p style="font-size: 2em; color: var(--primary-color);">åƒè³½è€…ï¼š<span id="final-name"></span></p>
            <p style="font-size: 4em; color: var(--accent-color);"><span id="final-score"></span> åˆ†</p>
            <p style="color: var(--gold-color); font-size: 1.5em; display:flex; align-items:center; justify-content:center; gap:10px;">
                <img src="images/coin.png" width="40"> ç²å¾—é‡‘å¹£ï¼š<span id="final-gold">0</span>
            </p>
            <div id="score-comment" style="font-size: 1.5em; margin-bottom: 20px;"></div>
            <div id="unlock-msg" style="color: var(--correct-color); font-weight: bold; display:none; font-size: 1.5em;">ğŸ”“ ä¸‹ä¸€é—œå·²è§£é–ï¼</div>
            
            <div id="new-card-alert" style="display:none; background:#e8f8f5; border:2px solid var(--correct-color); border-radius:15px; padding:10px; margin: 10px 0;">
                 <h3 style="margin:5px;">âœ¨ ç²å¾—æ–°å¡ç‰‡ï¼ âœ¨</h3>
            </div>

            <div style="display: flex; justify-content: center; gap: 10px; flex-wrap: wrap;">
                <button class="btn" onclick="goToLevelScreen()">ğŸ—ºï¸ è¿”å›åœ°åœ–</button>
                <button class="btn btn-green" onclick="toggleReview()">ğŸ“ æŸ¥çœ‹è§£æ</button>
            </div>
            <div id="full-review-area" style="display: none; margin-top: 20px;">
                <h3>ğŸ” è©¦å·å›é¡§</h3>
                <ul id="review-list" class="review-list"></ul>
            </div>
        </div>

        <div id="passport-modal" class="modal-overlay" onclick="closeModal('passport-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('passport-modal')">Ã—</button>
                <h2>ğŸ›‚ æˆ‘çš„æ—…éŠè­·ç…§</h2>
                <p>æ”¶é›†å°ç« ï¼Œè§£é–å†·çŸ¥è­˜ï¼</p>
                <div id="passport-grid" class="collection-grid"></div>
            </div>
        </div>

        <div id="funfact-modal" class="modal-overlay" onclick="closeModal('funfact-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('funfact-modal')">Ã—</button>
                <h3 id="ff-title">ğŸ’¡ å†·çŸ¥è­˜</h3>
                <div class="fun-fact-card">
                    <p id="ff-content"></p>
                </div>
            </div>
        </div>

        <div id="shop-modal" class="modal-overlay" onclick="closeModal('shop-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('shop-modal')">Ã—</button>
                <h2>ğŸª é“å…·å•†åº—</h2>
                <p>é‡‘å¹£ï¼šğŸ’° <span id="shop-gold-display">0</span></p>
                
                <div class="shop-grid" style="margin-bottom:20px;">
                    <div class="shop-item"><img src="images/item_5050.png"><h4>50/50</h4><p>åˆªå»å…©éŒ¯èª¤</p><div class="shop-price">ğŸ’° 50</div><button class="btn btn-sm btn-gold" onclick="buyItem('fifty', 50)">è³¼è²·</button></div>
                    <div class="shop-item"><img src="images/item_hint.png"><h4>æç¤ºå¡</h4><p>å·çœ‹æç¤º</p><div class="shop-price">ğŸ’° 30</div><button class="btn btn-sm btn-gold" onclick="buyItem('hint', 30)">è³¼è²·</button></div>
                    <div class="shop-item"><img src="images/item_skip.png"><h4>è·³éå¡</h4><p>è·³éæ­¤é¡Œ</p><div class="shop-price">ğŸ’° 100</div><button class="btn btn-sm btn-gold" onclick="buyItem('skip', 100)">è³¼è²·</button></div>
                </div>

                <div class="gacha-box">
                    <h3 style="color:var(--purple-color);">ğŸ° ç´€å¿µå“æ‰­è›‹æ©Ÿ (100é‡‘å¹£/æ¬¡)</h3>
                    <p>æ”¶é›†ç´€å¿µå“ä¾†è£é£¾åœ°åœ–å§ï¼</p>
                    <button class="btn btn-purple" onclick="playGacha()">ğŸ”® è½‰ä¸€æ¬¡</button>
                    <div id="gacha-anim" class="gacha-anim">ğŸŒ€ è½‰å‹•ä¸­...</div>
                    <div id="gacha-result" class="gacha-result"></div>
                </div>
            </div>
        </div>

        <div id="achievement-modal" class="modal-overlay" onclick="closeModal('achievement-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('achievement-modal')">Ã—</button>
                <h2>ğŸ… æˆå°±æ¦®è­½æ¦œ</h2>
                <div id="achievement-list" class="achievement-list"></div>
            </div>
        </div>

        <div id="history-screen" style="display:none;" class="fade-in">
             <h2>ğŸ“œ æ­·å²ç´€éŒ„</h2><ul id="history-list"></ul><div style="margin-top:20px;"><button class="btn" onclick="goToLevelScreen()">ğŸ—ºï¸ è¿”å›</button></div>
        </div>
        <div id="history-detail-screen" style="display: none;" class="fade-in">
            <h3>ğŸ“œ è©¦å·å›é¡§</h3> <ul id="history-review-list" class="review-list"></ul> <button class="btn" onclick="showHistory()">â¬…ï¸ è¿”å›</button>
        </div>

        <div id="reward-overlay" class="modal-overlay" onclick="document.getElementById('reward-overlay').style.display='none'">
            <div class="reward-content" onclick="event.stopPropagation()">
                <img id="reward-gif" class="reward-gif" src="">
                <div class="reward-text">ğŸ‰ æ­å–œéé—œï¼ ğŸ‰</div>
            </div>
        </div>
        
        <div id="card-modal" class="modal-overlay" onclick="closeModal('card-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('card-modal')">Ã—</button>
                <img id="modal-img" class="modal-img" src="">
                <h3 id="modal-title" style="margin-top:10px;"></h3>
            </div>
        </div>
    </div>

    <script>
        const LEVEL_CONFIG = [20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 20, 18];
        const ITEMS_PER_ROW = 4;
        const PLAYLIST = ['sounds/bgm1.mp3', 'sounds/bgm2.mp3', 'sounds/bgm3.mp3'];
        const REWARD_GIFS = ['reward_01.gif', 'reward_02.gif', 'reward_03.gif'];
        const ACHIEVEMENTS = [
            { id: 'sharpshooter', title: 'ç¥å°„æ‰‹', desc: 'é€£çºŒç­”å° 10 é¡Œ', img: 'ach_sniper.png' },
            { id: 'speedstar', title: 'é€Ÿåº¦ä¹‹æ˜Ÿ', desc: 'å–®ä¸€é—œå¡ 100 åˆ†ä¸”è€—æ™‚ < 3åˆ†é˜', img: 'ach_speed.png' },
            { id: 'rich', title: 'å¤§å¯Œç¿', desc: 'æŒæœ‰é‡‘å¹£è¶…é 1000', img: 'ach_rich.png' },
            { id: 'survivor', title: 'ä¸å±ˆä¸æ’“', desc: 'åœ¨éŒ¯é¡Œæœ¬ä¸­ç­”å° 5 é¡Œ', img: 'ach_shield.png' }
        ];
        const SOUVENIRS = [
            {id: 's01', icon: 'â›©ï¸', name: 'é³¥å±…'}, {id: 's02', icon: 'ğŸ¯', name: 'åŸå ¡'}, {id: 's03', icon: 'ğŸ—»', name: 'å¯Œå£«å±±'},
            {id: 's04', icon: 'ğŸ¦Š', name: 'ç‹ç‹¸'}, {id: 's05', icon: 'ğŸŒ¸', name: 'æ«»èŠ±'}, {id: 's06', icon: 'ğŸ', name: 'äººå¶'},
            {id: 's07', icon: 'ğŸœ', name: 'æ‹‰éºµ'}, {id: 's08', icon: 'ğŸ¥¬', name: 'æ³¡èœ'}, {id: 's09', icon: 'ğŸ±', name: 'ä¾¿ç•¶'},
            {id: 's10', icon: 'ğŸ£', name: 'å£½å¸'}, {id: 's11', icon: 'ğŸ¶', name: 'æ¸…é…’'}, {id: 's12', icon: 'ğŸ¥¢', name: 'ç­·å­'}
        ];

        let allQuestions = [], userName = "", currentAvatar = "avatar_boy1.png";
        let currentLevelIdx = 0, currentQuizData = [], score = 0, timerInterval, timeRemaining = 20, quizStartTime;
        let currentTrackIndex = 0, isPlaying = false;
        let currentCombo = 0, goldEarnedThisRound = 0;
        let isMistakeMode = false, userAnswers = {}, currentQuestionIndex = 0, currentLevel = 1;
        let isDecorationMode = false, selectedSouvenir = null;

        const bgmPlayer = document.getElementById('bgm-player');
        const audioCorrect = new Audio('sounds/correct.mp3'); audioCorrect.volume=0.4;
        const audioFail = new Audio('sounds/fail.mp3'); audioFail.volume=0.4;
        const audioWin = new Audio('sounds/unlock.mp3'); audioWin.volume=0.6;
        const audioBuy = new Audio('sounds/buy.mp3'); audioBuy.volume=0.6;
        const audioUse = new Audio('sounds/use.mp3'); audioUse.volume=0.6;
        const audioCombo = new Audio('sounds/combo.mp3'); audioCombo.volume=0.5;
        const audioTimeout = new Audio('sounds/timeout.mp3'); audioTimeout.volume=0.5;
        const audioUnlock = new Audio('sounds/unlock.mp3'); audioUnlock.volume=0.6;
        bgmPlayer.volume = 0.3; bgmPlayer.onended = nextTrack;

        function playMusic() { if(PLAYLIST.length===0)return; bgmPlayer.src = PLAYLIST[currentTrackIndex]; bgmPlayer.play().then(()=>isPlaying=true).catch(e=>{}); }
        function toggleMusic() { if (bgmPlayer.paused) { if(!bgmPlayer.src) bgmPlayer.src=PLAYLIST[currentTrackIndex]; bgmPlayer.play(); isPlaying=true; } else { bgmPlayer.pause(); isPlaying=false; } }
        function nextTrack() { currentTrackIndex = (currentTrackIndex + 1) % PLAYLIST.length; playMusic(); }

        fetch('questions.json').then(res => res.json()).then(data => { allQuestions = data; renderQuickLogin(); }).catch(e => console.error("é¡Œç›®è®€å–å¤±æ•—", e));

        function getUserKey(key) { return userName + '_' + key; }
        function getUserData() {
            let defaultData = { gold: 500, maxLevel: 0, levelScores: {}, inventory: { fifty: 2, hint: 2, skip: 2 }, stamps: [], collectedSouvenirs: [], decorations: [], daily: { date: '', tasks: [], claimed: false }, achievements: [] };
            let stored = JSON.parse(localStorage.getItem(getUserKey('userData'))) || {};
            return { ...defaultData, ...stored };
        }
        function saveUserData(data) { localStorage.setItem(getUserKey('userData'), JSON.stringify(data)); updateUI(); }

        function updateUI() {
            let data = getUserData();
            document.querySelectorAll('#user-gold, #shop-gold-display').forEach(el => el.innerText = data.gold);
            let title = "ğŸ’ èƒŒåŒ…å®¢"; if (data.maxLevel >= 5) title = "ğŸ§­ æ¢éšªå®¶"; if (data.maxLevel >= 10) title = "ğŸ”ï¸ é ˜ä¸»"; if (data.maxLevel >= 16) title = "ğŸ‘‘ åœ°ç†å¤§å¸«";
            if(document.getElementById('user-title')) document.getElementById('user-title').innerText = title;
            let rankImg = "rank_1.png"; if(data.maxLevel >= 5) rankImg="rank_5.png"; if(data.maxLevel >= 10) rankImg="rank_10.png"; if(data.maxLevel > 16) rankImg="rank_max.png";
            if(document.getElementById('rank-icon')) document.getElementById('rank-icon').src = "images/" + rankImg;
            ['fifty', 'hint', 'skip'].forEach(k => { if(document.getElementById('count-'+k)) document.getElementById('count-'+k).innerText = data.inventory[k]; });
        }

        function renderQuickLogin() {
            let users = JSON.parse(localStorage.getItem('savedUsers')) || [];
            let html = '';
            users.forEach(u => {
                let name = u.name || u; let avatar = u.avatar || 'avatar_boy1.png';
                html += `<div class="user-tag" onclick="login('${name}', '${avatar}')"><img src="images/${avatar}" style="width:20px;border-radius:50%;">${name}</div>`;
            });
            document.getElementById('quick-login-area').innerHTML = html;
        }
        function selectAvatar(img, el) { currentAvatar = img; document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected')); el.classList.add('selected'); }
        function loginAndStart() { let name = document.getElementById('username').value.trim(); if(!name) return alert("è«‹è¼¸å…¥åå­—"); login(name, currentAvatar); }
        function login(name, avatar) {
            userName = name; currentAvatar = avatar;
            let users = JSON.parse(localStorage.getItem('savedUsers')) || [];
            users = users.filter(u => (u.name || u) !== name); users.push({name, avatar});
            localStorage.setItem('savedUsers', JSON.stringify(users));
            
            // æ¯æ—¥ç°½åˆ°é‚è¼¯
            let data = getUserData(); let today = new Date().toDateString();
            if (data.daily.date !== today) {
                data.daily.date = today; data.daily.claimed = false; 
                data.gold += 50; document.getElementById('daily-reward-msg').style.display = 'block'; setTimeout(() => document.getElementById('daily-reward-msg').style.display = 'none', 3000);
                saveUserData(data);
            }
            
            showScreen('level-screen'); renderMap(); renderDecorations(); updateUI();
            if (!isPlaying) playMusic();
        }
        function logout() { location.reload(); }
        function exitQuiz() { if(confirm("ç¢ºå®šè¦æ”¾æ£„ç›®å‰çš„é€²åº¦å›åˆ°æ¢éšªåœ°åœ–å—ï¼Ÿ")) goToLevelScreen(); }

        // --- åœ°åœ– ---
        function renderMap() {
            let container = document.getElementById('level-map'); container.innerHTML = '<div id="decoration-overlay" onclick="placeDecorationOnMap(event)"></div>';
            let data = getUserData(); let maxLvl = data.maxLevel;
            let rows = []; for (let i = 0; i < LEVEL_CONFIG.length; i += ITEMS_PER_ROW) rows.push(LEVEL_CONFIG.slice(i, i + ITEMS_PER_ROW));
            rows.forEach((rowItems, rIdx) => {
                let rowDiv = document.createElement('div'); rowDiv.className = 'level-row' + (rIdx % 2 !== 0 ? ' reverse' : '');
                let startNum = rIdx * ITEMS_PER_ROW;
                rowItems.forEach((_, idx) => {
                    let absIdx = startNum + idx;
                    let btn = document.createElement('button'); btn.className = 'level-btn';
                    let label = `ç¬¬ ${absIdx+1} é—œ`;
                    let status = "ğŸ”’";
                    if (absIdx <= maxLvl) {
                        let score = data.levelScores[absIdx]; status = (score !== undefined) ? (score >= 80 ? "â­" : "ğŸš©") : "GO!";
                        btn.onclick = () => enterLevel(absIdx);
                    } else btn.disabled = true;
                    btn.innerHTML = `<div class="level-title">${label}</div><div class="level-score">${status}</div>`;
                    if (absIdx === maxLvl) { let ava = document.createElement('img'); ava.src = "images/" + currentAvatar; ava.className = "map-avatar"; btn.appendChild(ava); }
                    let wrapper = document.createElement('div'); wrapper.className = 'level-wrapper'; wrapper.appendChild(btn);
                    if (idx < rowItems.length - 1) { let arrow = document.createElement('div'); arrow.className = 'arrow-icon'; arrow.innerText = 'âœ'; if(rIdx % 2 !== 0) arrow.style.transform = "scaleX(-1)"; wrapper.appendChild(arrow); }
                    rowDiv.appendChild(wrapper);
                });
                container.appendChild(rowDiv);
                if (rIdx < rows.length - 1) { let connectorDiv = document.createElement('div'); connectorDiv.className = 'row-connector'; let downArrow = document.createElement('div'); downArrow.className = 'arrow-icon arrow-down'; downArrow.innerText = 'â¬‡'; if (rIdx % 2 !== 0) connectorDiv.classList.add('left'); connectorDiv.appendChild(downArrow); container.appendChild(connectorDiv); }
            });
        }

        // --- éŠæˆ²é‚è¼¯ ---
        function enterLevel(idx) { currentLevelIdx = idx; startMCQ(idx); }
        function startMCQ(levelIdx) {
            let startQ = 0; for(let i=0; i<levelIdx; i++) startQ += MCQ_COUNTS[i];
            let count = MCQ_COUNTS[levelIdx];
            currentQuizData = allQuestions.slice(startQ, startQ + count);
            currentQuestionIndex = 0; score = 0; currentCombo = 0; goldEarnedThisRound = 0; quizStartTime = Date.now();
            showScreen('quiz-content'); document.getElementById('level-title').innerText = `ç¬¬ ${levelIdx+1} é—œ`; document.getElementById('total-q-num').innerText = count;
            loadQuestion();
        }
        function loadQuestion() {
            let q = currentQuizData[currentQuestionIndex];
            document.getElementById('current-q-num').innerText = currentQuestionIndex + 1;
            document.getElementById('question-text').innerText = (currentQuestionIndex + 1) + ". " + q.question;
            let imgEl = document.getElementById('question-image');
            if(q.image) { imgEl.src = q.image; imgEl.style.display='block'; } else imgEl.style.display='none';
            let opts = document.getElementById('options-list'); opts.innerHTML = '';
            q.options.forEach(opt => { opts.innerHTML += `<button class="option-btn" onclick="checkMCQ(this, '${opt}')">${opt}</button>`; });
            document.getElementById('explanation').style.display = 'none'; document.getElementById('next-btn').style.display = 'none';
            resetTimer();
        }
        function checkMCQ(btn, ans) {
            clearInterval(timerInterval);
            let q = currentQuizData[currentQuestionIndex];
            let correctCode = q.answer.substring(0,1); let userCode = ans.substring(0,1); if (ans.startsWith('(')) userCode = ans.substring(1,2);
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            if (userCode === correctCode) { 
                if(btn) btn.classList.add('correct'); score++; currentCombo++;
                let earn = 10 + (currentCombo > 1 ? (currentCombo * 2) : 0); goldEarnedThisRound += earn;
                if(currentCombo > 1) { let el = document.getElementById('combo-display'); el.innerText = `ğŸ”¥ COMBO x${currentCombo}`; el.style.display='block'; audioCombo.play().catch(()=>{}); }
                audioCorrect.play(); 
            } else { 
                if(btn) btn.classList.add('wrong'); currentCombo=0; audioFail.play(); 
            }
            document.getElementById('explanation-text').innerText = q.explanation; document.getElementById('explanation').style.display = 'block'; document.getElementById('next-btn').style.display = 'block';
        }
        function nextQuestion() { currentQuestionIndex++; if(currentQuestionIndex < currentQuizData.length) loadQuestion(); else endLevel(true); }

        function resetTimer() {
            timeRemaining = 20; document.getElementById('timer-bar').style.width = '100%'; clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--; document.getElementById('timer-bar').style.width = (timeRemaining/20*100)+'%';
                if(timeRemaining<=0) { clearInterval(timerInterval); audioTimeout.play().catch(()=>{}); currentCombo=0; checkMCQ(null, "WRONG"); }
            }, 1000);
        }

        // --- çµç®— ---
        function endLevel(isMCQ, isWin=false) {
            showScreen('score-box');
            let finalScore = Math.round((score / currentQuizData.length) * 100);
            document.getElementById('final-score').innerText = finalScore; document.getElementById('final-name').innerText = userName;
            let earnedGold = goldEarnedThisRound;
            document.getElementById('earned-gold').innerText = earnedGold;
            
            let data = getUserData(); data.gold += earnedGold;
            let unlockMsg = document.getElementById('unlock-msg'); let newStampAlert = document.getElementById('new-stamp-alert');
            unlockMsg.style.display='none'; newStampAlert.style.display='none';

            // åŠæ ¼é–€æª»è¨­å®šç‚º 80 åˆ†
            if (finalScore >= 80) {
                if (currentLevelIdx === data.maxLevel && currentLevelIdx < LEVEL_CONFIG.length - 1) { data.maxLevel++; unlockMsg.style.display = 'block'; }
                if (!data.levelScores[currentLevelIdx] || finalScore > data.levelScores[currentLevelIdx]) data.levelScores[currentLevelIdx] = finalScore;
                // ç²å¾—åœ–é‘‘å¡ç‰‡ (80åˆ†)
                if (!data.stamps.includes(currentLevelIdx)) {
                    data.stamps.push(currentLevelIdx);
                    newStampAlert.style.display = 'block';
                }
                
                confetti({ particleCount: 150, spread: 180 }); audioWin.play();
                let gif = REWARD_GIFS[Math.floor(Math.random()*REWARD_GIFS.length)];
                document.getElementById('reward-gif').src = "images/" + gif;
                document.getElementById('reward-overlay').style.display = 'flex';
            }
            saveUserData(data); checkAchievements(finalScore);
            saveHistory(userName, finalScore, currentQuizQuestions, userAnswers, isMistakeMode ? "éŒ¯é¡ŒæŒ‘æˆ°" : `ç¬¬ ${currentLevelIdx+1} é—œ`);
        }

        function checkAchievements(finalScore) {
            let data = getUserData(); let newUnlock = false;
            if (finalScore === 100 && !data.achievements.includes('sharpshooter')) { data.achievements.push('sharpshooter'); newUnlock = true; }
            if (data.gold >= 1000 && !data.achievements.includes('rich')) { data.achievements.push('rich'); newUnlock = true; }
            if(newUnlock) { saveUserData(data); audioUnlock.play().catch(e=>{}); alert("ğŸ‰ è§£é–æ–°æˆå°±ï¼"); }
        }

        // --- è£é£¾ ---
        function toggleDecorationMode() {
            isDecorationMode = !isDecorationMode;
            document.getElementById('decoration-overlay').style.display = isDecorationMode ? 'block' : 'none';
            document.getElementById('decoration-toolbar').style.display = isDecorationMode ? 'flex' : 'none';
            if(isDecorationMode) renderSouvenirList();
        }
        function renderSouvenirList() {
            let data = getUserData();
            let list = document.getElementById('souvenir-list'); list.innerHTML = "";
            SOUVENIRS.forEach(item => {
                let has = data.collectedSouvenirs.includes(item.id);
                let div = document.createElement('div'); div.className = `souvenir-item ${has?'':'locked'}`; div.innerText = item.icon;
                if(has) div.onclick = () => { selectedSouvenir = item; document.querySelectorAll('.souvenir-item').forEach(e=>e.classList.remove('selected')); div.classList.add('selected'); };
                list.appendChild(div);
            });
        }
        function placeDecorationOnMap(e) {
            if(!selectedSouvenir) return;
            let rect = document.getElementById('level-map').getBoundingClientRect();
            let x = (e.clientX - rect.left)/rect.width*100; let y = (e.clientY - rect.top)/rect.height*100;
            let data = getUserData(); data.decorations.push({id:Date.now(), icon:selectedSouvenir.icon, x, y}); saveUserData(data);
            renderDecorations(); audioUse.play().catch(()=>{});
        }
        function renderDecorations() {
            let data = getUserData();
            document.querySelectorAll('.map-decoration').forEach(e => e.remove());
            let container = document.getElementById('level-map');
            data.decorations.forEach(d => {
                let el = document.createElement('div'); el.className = 'map-decoration'; el.innerText = d.icon;
                el.style.left = d.x+'%'; el.style.top = d.y+'%';
                el.onclick = (e) => { if(isDecorationMode) { e.stopPropagation(); if(confirm("ç§»é™¤?")) { data.decorations=data.decorations.filter(x=>x.id!==d.id); saveUserData(data); renderDecorations(); } } };
                container.appendChild(el);
            });
        }
        function playGacha() {
            let data = getUserData(); if(data.gold < 100) { alert("é‡‘å¹£ä¸è¶³"); return; }
            data.gold -= 100; saveUserData(data); audioBuy.play().catch(()=>{});
            document.getElementById('gacha-anim').style.display = 'block'; document.getElementById('gacha-result').style.display = 'none';
            setTimeout(() => {
                document.getElementById('gacha-anim').style.display = 'none';
                let prize = SOUVENIRS[Math.floor(Math.random() * SOUVENIRS.length)];
                if(!data.collectedSouvenirs.includes(prize.id)) { data.collectedSouvenirs.push(prize.id); saveUserData(data); }
                document.getElementById('gacha-result').innerText = `ç²å¾—ï¼š${prize.icon} ${prize.name}ï¼`;
                document.getElementById('gacha-result').style.display = 'block';
                audioWin.play().catch(()=>{});
            }, 1000);
        }

        // --- è¼”åŠ© ---
        function showScreen(id) { document.querySelectorAll('.quiz-container > div').forEach(el => { if(el.id && !el.id.includes('modal')) el.style.display = 'none'; }); document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openPassport() { 
            document.getElementById('collection-screen').style.display = 'block';
            showCollection(); // å‘¼å« v3.x ç‰ˆçš„åœ–é‘‘å‡½å¼ (é€™è£¡æ²¿ç”¨èˆŠç‰ˆåœ–é‘‘UIï¼Œä½†æŒ‰éˆ•æ”¹åç‚ºè­·ç…§)
        }
        function showCollection() {
            document.querySelectorAll('.quiz-container > div').forEach(el => el.style.display = 'none');
            document.getElementById('collection-screen').style.display = 'block';
            const grid = document.getElementById('collection-grid'); grid.innerHTML = ""; const data = getUserData();
            for (let i = 1; i <= LEVEL_CONFIG.length; i++) {
                let bestScore = data.levelScores[i-1]; // æ³¨æ„ç´¢å¼•å°é½Š
                let isUnlocked = (bestScore !== undefined && bestScore >= 80);
                let numStr = i < 10 ? `0${i}` : `${i}`; let imgSrc = `images/card_${numStr}.jpg`;
                let cardItem = document.createElement('div');
                if (isUnlocked) {
                    cardItem.className = 'card-item'; cardItem.innerHTML = `<img src="${imgSrc}" class="card-img" onerror="this.style.display='none'">`;
                    cardItem.onclick = () => openCardModal(imgSrc, `ç¬¬ ${i} é—œçå‹µ`);
                } else {
                    cardItem.className = 'card-item locked'; cardItem.innerHTML = `<img src="${imgSrc}" class="card-img" onerror="this.style.display='none'"><div class="card-overlay"><div class="card-lock-icon">ğŸ”’</div><div class="card-label">ç¬¬ ${i} é—œ</div></div>`;
                }
                grid.appendChild(cardItem);
            }
        }
        function openCardModal(src, title) { document.getElementById('modal-img').src = src; document.getElementById('modal-title').innerText = title; document.getElementById('card-modal').style.display = 'flex'; }
        function openShop() { document.getElementById('shop-modal').style.display = 'flex'; document.getElementById('shop-gold-display').innerText = getUserData().gold; }
        function buyItem(item, cost) { let data = getUserData(); if(data.gold>=cost) { data.gold-=cost; data.inventory[item]++; saveUserData(data); alert("è³¼è²·æˆåŠŸ"); document.getElementById('shop-gold-display').innerText=data.gold; } else alert("é‡‘å¹£ä¸è¶³"); }
        function usePowerUp(type) { let data = getUserData(); if(data.inventory[type]>0) { data.inventory[type]--; saveUserData(data); if(type==='fifty') { let correct=currentQuizData[currentQuestionIndex].answer[1]; Array.from(document.querySelectorAll('.option-btn')).filter(b=>!b.innerText.includes(correct)).slice(0,2).forEach(b=>b.style.visibility='hidden'); } else if(type==='hint') alert(currentQuizData[currentQuestionIndex].explanation); else if(type==='skip') nextQuestion(); } else alert("é“å…·ä¸è¶³"); updateUI(); }
        
        // --- éŒ¯é¡Œèˆ‡æ­·å² (ç°¡åŒ–) ---
        function goToLevelScreen() { showScreen('level-screen'); renderMap(); updateUI(); renderDecorations(); }
        
        // ä»¥ä¸‹æ²¿ç”¨ v4.1 çš„æ­·å²ç´€éŒ„ç›¸é—œå‡½å¼
        function saveHistory(name, score, questionsData, answersData, modeName) {
            let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || [];
            let record = { id: Date.now(), name: name, score: score, date: new Date().toLocaleString(), mode: modeName, answers: answersData, questionIds: questionsData.map(q => q.id) };
            history.push(record); localStorage.setItem(getUserKey('quizHistory'), JSON.stringify(history));
        }
        function showHistory() {
            document.querySelectorAll('.quiz-container > div').forEach(el => el.style.display = 'none'); document.getElementById('history-screen').style.display = 'block';
            let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || [];
            let list = document.getElementById('history-list'); list.innerHTML = "";
            if(history.length === 0) list.innerHTML = "<li style='justify-content:center'>æš«ç„¡ç´€éŒ„</li>";
            else {
                history.reverse().forEach(rec => {
                    let li = document.createElement('li');
                    li.innerHTML = `<div class="history-info"><strong>${rec.mode}</strong> - <span style="color:${rec.score>=80?'#27AE60':'#C0392B'}">${rec.score}åˆ†</span><br><small style="color:gray">${rec.date}</small></div><div class="history-actions"><button class="btn btn-green btn-sm" onclick="replayHistory(${rec.id})">å›æ”¾</button><button class="btn btn-red btn-sm" onclick="deleteHistoryItem(${rec.id})">ğŸ—‘ï¸</button></div>`;
                    list.appendChild(li);
                });
            }
        }
        function deleteHistoryItem(id) { if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿ")) return; if(!confirm("ç„¡æ³•å¾©åŸï¼Œç¢ºå®šï¼Ÿ")) return; let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || []; history = history.filter(r => r.id !== id); localStorage.setItem(getUserKey('quizHistory'), JSON.stringify(history)); showHistory(); }
        function replayHistory(recordId) { let history = JSON.parse(localStorage.getItem(getUserKey('quizHistory'))) || []; let record = history.find(r => r.id === recordId); if (!record) return; document.querySelectorAll('.quiz-container > div').forEach(el => el.style.display = 'none'); document.getElementById('history-detail-screen').style.display = 'block'; let examQuestions = allQuestions.filter(q => record.questionIds.includes(q.id)); renderReviewList('history-review-list', examQuestions, record.answers); }
    </script>
</body>
</html>