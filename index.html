<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ°ç†ç¬¬3å†Š æ±åŒ—äºçš„è‡ªç„¶ç’°å¢ƒ</title>
    <link href="https://fonts.googleapis.com/css2?family=CwTeXYen:wght@400;600&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.6.0/dist/confetti.browser.min.js"></script>
    <style>
        :root {
            --primary-color: #FF8C42; --secondary-color: #F9F871; --bg-color: #FFF5E1;
            --text-color: #4A4A4A; --accent-color: #FF5E5E; --correct-color: #2ECC71;
            --wrong-color: #E74C3C; --locked-color: #BDC3C7; --music-btn-color: #3498db;
            --gold-color: #f1c40f; --purple-color: #9b59b6;
        }
        body { font-family: 'CwTeXYen', "Microsoft JhengHei", sans-serif; max-width: 900px; margin: 0 auto; padding: 20px; background-color: var(--bg-color); color: var(--text-color); background-image: radial-gradient(#FFD166 2px, transparent 2px); background-size: 30px 30px; min-height: 100vh; }
        h1 { font-size: 2.5em; color: #D35400; text-align: center; margin: 0; text-shadow: 2px 2px 0px white; }
        
        /* é€šç”¨å®¹å™¨ */
        .quiz-container { background: rgba(255,255,255,0.95); padding: 30px; border-radius: 25px; box-shadow: 0 10px 25px rgba(0,0,0,0.15); border: 4px solid var(--primary-color); min-height: 500px; position: relative; }
        .fade-in { animation: fadeIn 0.4s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes pop { 0% { transform: scale(1); } 50% { transform: scale(1.2); } 100% { transform: scale(1); } }

        /* æŒ‰éˆ• */
        .btn { background-color: var(--primary-color); color: white; border: none; padding: 10px 20px; font-size: 1.2em; border-radius: 50px; cursor: pointer; transition: 0.3s; box-shadow: 0 5px 0 #E67E22; margin: 5px; font-weight: bold; }
        .btn:hover { transform: translateY(-3px); } .btn:active { transform: translateY(2px); box-shadow: none; }
        .btn-green { background-color: var(--correct-color); box-shadow: 0 5px 0 #27AE60; }
        .btn-red { background-color: var(--accent-color); box-shadow: 0 5px 0 #C0392B; }
        .btn-blue { background-color: #3498db; box-shadow: 0 5px 0 #2980b9; }
        .btn-gold { background-color: var(--gold-color); box-shadow: 0 5px 0 #d4ac0d; color: #fff; }
        .btn-purple { background-color: var(--purple-color); box-shadow: 0 5px 0 #8e44ad; }
        .btn-sm { padding: 6px 12px; font-size: 1em; margin: 0 2px; box-shadow: 0 3px 0 rgba(0,0,0,0.2); }
        .btn-music { background-color: var(--music-btn-color); box-shadow: 0 3px 0 #2980b9; }

        /* ç™»å…¥ & è§’è‰² */
        input[type="text"] { padding: 12px; font-size: 1.5em; border: 3px solid var(--primary-color); border-radius: 15px; margin: 15px; text-align: center; width: 80%; }
        .avatar-selection { display: flex; justify-content: center; gap: 15px; margin: 20px 0; }
        .avatar-option { width: 80px; height: 80px; border-radius: 50%; border: 4px solid transparent; cursor: pointer; object-fit: cover; background: white; }
        .avatar-option.selected { border-color: var(--correct-color); box-shadow: 0 0 15px var(--correct-color); transform: scale(1.1); }
        .quick-login-area { margin-top: 15px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px; }
        .user-tag { background: #FFF0D4; border: 2px solid var(--primary-color); padding: 5px 15px; border-radius: 20px; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        
        /* åœ°åœ–èˆ‡Så‹æ’åˆ— */
        #level-screen { background-image: url('images/map_bg.jpg'); background-size: cover; background-position: center; border-radius: 15px; padding: 20px; min-height: 400px; position: relative; }
        .status-bar { display: flex; justify-content: space-between; align-items: center; background: rgba(255,255,255,0.9); padding: 10px 20px; border-radius: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .level-map-container { display: flex; flex-direction: column; align-items: center; gap: 10px; }
        .level-row { display: flex; justify-content: center; gap: 15px; }
        .level-row.reverse { flex-direction: row-reverse; }
        .level-btn { width: 90px; height: 90px; border-radius: 50%; border: 4px solid var(--primary-color); background: white; cursor: pointer; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; box-shadow: 0 5px 0 rgba(0,0,0,0.2); z-index: 2; color: var(--primary-color); font-weight: bold; }
        .level-btn:disabled { background: #e0e0e0; border-color: #999; color: #999; }
        .level-btn.special-level { border-color: var(--purple-color); color: var(--purple-color); } /* ç‰¹æ®Šé—œå¡é¡è‰² */
        .map-avatar { position: absolute; top: -50px; left: 50%; transform: translateX(-50%); width: 50px; z-index: 10; animation: float 2s infinite; filter: drop-shadow(0 5px 5px rgba(0,0,0,0.3)); }
        @keyframes float { 0%, 100% { transform: translate(-50%, 0); } 50% { transform: translate(-50%, -10px); } }
        .arrow-icon { font-size: 2em; color: var(--primary-color); text-shadow: 1px 1px 0 white; display: flex; align-items: center; }

        /* æ¯æ—¥ä»»å‹™èˆ‡è­·ç…§ */
        .daily-panel { background: #e0f7fa; padding: 10px; border-radius: 10px; margin-bottom: 10px; border: 2px solid #4dd0e1; text-align: left; font-size: 0.9em; }
        .daily-item { display: flex; justify-content: space-between; margin: 5px 0; }
        .stamp-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(100px, 1fr)); gap: 15px; }
        .stamp-item { aspect-ratio: 1; border: 2px dashed #ccc; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; background: #fff; transition: 0.3s; opacity: 0.5; }
        .stamp-item.unlocked { border: 3px solid var(--primary-color); opacity: 1; background: #fffbeb; transform: rotate(-5deg); box-shadow: 2px 2px 5px rgba(0,0,0,0.2); }
        .stamp-img { width: 80%; height: 80%; object-fit: contain; }

        /* è¿·ä½ éŠæˆ²æ¨£å¼ */
        .minigame-container { text-align: center; padding: 20px; }
        .mg-match-row { display: flex; justify-content: space-between; margin: 10px 0; gap: 20px; }
        .mg-item { flex: 1; padding: 15px; border: 2px solid #ccc; border-radius: 10px; cursor: pointer; background: white; transition: 0.2s; }
        .mg-item.selected { background: #fff3cd; border-color: var(--gold-color); transform: scale(1.05); }
        .mg-item.matched { background: #d4edda; border-color: var(--correct-color); opacity: 0.6; pointer-events: none; }
        
        .mg-map-area { position: relative; display: inline-block; margin: 0 auto; border: 3px solid #333; cursor: crosshair; }
        .mg-map-img { max-width: 100%; display: block; }
        .mg-map-target { position: absolute; width: 40px; height: 40px; background: rgba(255,0,0,0.3); border: 2px solid red; border-radius: 50%; display: none; } /* é™¤éŒ¯ç”¨ */

        .mg-sort-list { display: flex; flex-direction: column; gap: 10px; max-width: 300px; margin: 0 auto; }
        .mg-sort-item { padding: 15px; background: white; border: 2px solid var(--primary-color); border-radius: 10px; cursor: grab; font-weight: bold; }
        .mg-sort-item:active { cursor: grabbing; background: #ffe0b2; }

        /* ä¸€èˆ¬æ¸¬é©— */
        .question-box { background-color: #FFF9F0; border-left: 8px solid var(--accent-color); padding: 20px; border-radius: 15px; margin-bottom: 20px; }
        .question-text { font-size: 1.6em; font-weight: bold; line-height: 1.5; }
        .question-img { max-width: 100%; max-height: 220px; display: block; margin: 10px auto; object-fit: contain; }
        .option-btn { width: 100%; padding: 15px; margin: 8px 0; text-align: left; background: white; border: 2px solid #ffe4b5; border-radius: 15px; font-size: 1.3em; cursor: pointer; }
        .option-btn:hover { background-color: #fff0d4; border-color: var(--primary-color); }
        .correct { background: #d4edda !important; border-color: #28a745 !important; }
        .wrong { background: #f8d7da !important; border-color: #dc3545 !important; }
        .timer-bar { height: 8px; background: var(--wrong-color); width: 100%; transition: width 1s linear; border-radius: 4px; margin-bottom: 10px; }
        
        /* å½ˆçª— */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; display: none; justify-content: center; align-items: center; }
        .modal-content { background: white; padding: 20px; border-radius: 15px; max-width: 90%; max-height: 90%; overflow-y: auto; text-align: center; position: relative; }
        .modal-close { position: absolute; top: 10px; right: 10px; background: #eee; width: 30px; height: 30px; border-radius: 50%; border: none; cursor: pointer; font-weight: bold; }
        .fun-fact-card { background: #e8f8f5; padding: 15px; border-radius: 10px; border: 2px dashed var(--correct-color); color: #00695c; }
    </style>
</head>
<body>

    <div class="quiz-container">
        <audio id="bgm-player"></audio>

        <div id="welcome-screen" class="fade-in">
            <h1>åœ°ç†ç¬¬3å†Š æ±åŒ—äºçš„è‡ªç„¶ç’°å¢ƒ</h1>
            <div style="font-size: 4em; margin: 20px;">ğŸŒâœ¨ğŸ‡¯ğŸ‡µğŸ‡°ğŸ‡·</div>
            <p>è«‹è¼¸å…¥åå­—ä¸¦é¸æ“‡å¤¥ä¼´ï¼š</p>
            <input type="text" id="username" placeholder="ä½ çš„åå­—..." />
            <div class="avatar-selection">
                <img src="images/avatar_boy1.png" class="avatar-option selected" onclick="selectAvatar('avatar_boy1.png', this)">
                <img src="images/avatar_boy2.png" class="avatar-option" onclick="selectAvatar('avatar_boy2.png', this)">
                <img src="images/avatar_girl1.png" class="avatar-option" onclick="selectAvatar('avatar_girl1.png', this)">
                <img src="images/avatar_girl2.png" class="avatar-option" onclick="selectAvatar('avatar_girl2.png', this)">
            </div>
            <div id="quick-login-area"></div>
            
            <div id="daily-reward-msg" style="display:none; background:#fff3cd; padding:10px; margin:10px; border-radius:10px; border:2px solid #ffc107;">
                ğŸ“… æ¯æ—¥ç°½åˆ°æˆåŠŸï¼ç²å¾— 50 é‡‘å¹£ï¼ğŸ’°
            </div>

            <button class="btn" onclick="loginAndStart()">ğŸ‘‰ é€²å…¥æ¢éšª</button>
        </div>

        <div id="level-screen" style="display: none;" class="fade-in">
            <div class="status-bar">
                <div style="display:flex; align-items:center; gap:10px;">
                    <img id="user-avatar-display" src="" style="width:50px; border-radius:50%; border:2px solid #fff;">
                    <div>
                        <span id="display-name" style="font-weight:bold;"></span>
                        <span id="user-title" style="font-size:0.8em; background:#eee; padding:2px 5px; border-radius:5px;"></span>
                    </div>
                </div>
                <div style="font-weight:bold; color:var(--gold-color);">ğŸ’° <span id="user-gold">0</span></div>
            </div>

            <div class="daily-panel">
                <strong>ğŸ“… ä»Šæ—¥ä»»å‹™</strong>
                <div id="daily-tasks-list"></div>
            </div>

            <div id="level-map" class="level-map-container"></div>
            
            <div style="margin-top: 20px; display: flex; flex-wrap: wrap; justify-content: center; gap: 10px;">
                <button class="btn btn-purple" onclick="openPassport()">ğŸ›‚ è­·ç…§</button>
                <button class="btn btn-gold" onclick="openShop()">ğŸª å•†åº—</button>
                <button class="btn btn-green" onclick="showHistory()">ğŸ“œ ç´€éŒ„</button>
                <button class="btn btn-gray" onclick="logout()">ğŸšª ç™»å‡º</button>
            </div>
        </div>

        <div id="quiz-content" style="display: none;" class="fade-in">
            <div class="quiz-header">
                <h3 id="level-title">ç¬¬ X é—œ</h3>
                <button class="btn btn-gray btn-sm" onclick="exitQuiz()">ğŸ  è¿”å›</button>
            </div>
            <div class="timer-bar" id="timer-bar"></div>
            <div style="text-align:right; color:gray;">é¡Œè™Ÿ: <span id="current-q-num">1</span> / <span id="total-q-num">20</span></div>
            
            <div class="question-box">
                <div id="question-text" class="question-text"></div>
                <img id="question-image" class="question-img" style="display: none;" />
            </div>
            <ul id="options-list" style="list-style: none; padding: 0;"></ul>
            
            <div style="display:flex; justify-content:center; gap:15px; margin-top:10px;">
                <button class="btn btn-sm btn-gold" onclick="usePowerUp('fifty')">âœ‚ï¸ 50/50 (<span id="count-fifty">0</span>)</button>
                <button class="btn btn-sm btn-gold" onclick="usePowerUp('hint')">ğŸ’¡ æç¤º (<span id="count-hint">0</span>)</button>
                <button class="btn btn-sm btn-gold" onclick="usePowerUp('skip')">â­ï¸ è·³é (<span id="count-skip">0</span>)</button>
            </div>

            <div id="explanation" class="explanation-box" style="display: none;">
                <strong>ğŸ’¡ è§£æï¼š</strong> <span id="explanation-text"></span>
            </div>
            <button id="next-btn" class="btn" style="display: none; width: 100%; margin-top: 20px;" onclick="nextQuestion()">ä¸‹ä¸€é¡Œ â¡ï¸</button>
        </div>

        <div id="minigame-screen" style="display: none;" class="fade-in">
            <div class="quiz-header">
                <h3 id="mg-title">ç‰¹æ®Šé—œå¡</h3>
                <button class="btn btn-gray btn-sm" onclick="exitQuiz()">ğŸ  æ”¾æ£„</button>
            </div>
            <p id="mg-instruction" style="text-align:center; font-size:1.2em;"></p>
            <div id="mg-container" class="minigame-container"></div>
            <div style="text-align:center; margin-top:20px;">
                <button id="mg-submit-btn" class="btn btn-green" onclick="checkMiniGame()">âœ… é€å‡ºç­”æ¡ˆ</button>
            </div>
        </div>

        <div id="score-box" style="display: none; text-align: center;" class="fade-in">
            <h2>ğŸ‰ æŒ‘æˆ°çµæŸï¼</h2>
            <p style="font-size: 4em; color: var(--accent-color); margin: 10px 0;"><span id="final-score"></span></p>
            <p>ğŸ’° ç²å¾—é‡‘å¹£ï¼š<span id="earned-gold">0</span></p>
            <div id="score-comment" style="font-size: 1.2em;"></div>
            
            <div id="new-stamp-alert" style="display:none; margin-top:15px; padding:15px; background:#fffbeb; border:2px dashed var(--primary-color); border-radius:15px;">
                <h3>ğŸ›‚ ç²å¾—æ–°å…¥å¢ƒç« ï¼</h3>
                <img id="new-stamp-img" src="" style="width:80px; transform:rotate(-10deg);">
            </div>

            <div style="margin-top:20px;">
                <button class="btn" onclick="goToLevelScreen()">ğŸ—ºï¸ è¿”å›åœ°åœ–</button>
            </div>
        </div>

        <div id="passport-modal" class="modal-overlay" onclick="closeModal('passport-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('passport-modal')">Ã—</button>
                <h2>ğŸ›‚ æˆ‘çš„æ—…éŠè­·ç…§</h2>
                <p>æ”¶é›†å°ç« ï¼Œè§£é–å†·çŸ¥è­˜ï¼</p>
                <div id="passport-grid" class="stamp-grid"></div>
            </div>
        </div>

        <div id="funfact-modal" class="modal-overlay" onclick="closeModal('funfact-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('funfact-modal')">Ã—</button>
                <h3 id="ff-title">ğŸ’¡ å†·çŸ¥è­˜</h3>
                <div class="fun-fact-card">
                    <p id="ff-content"></p>
                </div>
            </div>
        </div>

        <div id="shop-modal" class="modal-overlay" onclick="closeModal('shop-modal')">
            <div class="modal-content" onclick="event.stopPropagation()">
                <button class="modal-close" onclick="closeModal('shop-modal')">Ã—</button>
                <h2>ğŸª é“å…·å•†åº—</h2>
                <p>é‡‘å¹£ï¼šğŸ’° <span id="shop-gold-display">0</span></p>
                <div style="display:flex; justify-content:space-around; flex-wrap:wrap;">
                    <div style="border:1px solid #ccc; padding:10px; border-radius:10px; width:100px;">
                        <div>âœ‚ï¸ 50/50</div><div>$50</div><button class="btn btn-sm btn-gold" onclick="buyItem('fifty', 50)">è²·</button>
                    </div>
                    <div style="border:1px solid #ccc; padding:10px; border-radius:10px; width:100px;">
                        <div>ğŸ’¡ æç¤º</div><div>$30</div><button class="btn btn-sm btn-gold" onclick="buyItem('hint', 30)">è²·</button>
                    </div>
                    <div style="border:1px solid #ccc; padding:10px; border-radius:10px; width:100px;">
                        <div>â­ï¸ è·³é</div><div>$100</div><button class="btn btn-sm btn-gold" onclick="buyItem('skip', 100)">è²·</button>
                    </div>
                </div>
            </div>
        </div>

        <div id="history-screen" style="display:none;" class="fade-in">
             <h2>ğŸ“œ æ­·å²ç´€éŒ„</h2><ul id="history-list"></ul><button class="btn" onclick="goToLevelScreen()">è¿”å›</button>
        </div>

    </div>

    <script>
        // --- é—œå¡è¨­å®š (å…±17é—œ) ---
        const LEVEL_TYPES = [
            'mcq', 'mcq', 'mcq', 'game_match1', 
            'mcq', 'mcq', 'mcq', 'game_map1', 
            'mcq', 'mcq', 'mcq', 'game_sort1', 
            'mcq', 'mcq', 'mcq', 'game_match2', 
            'mcq'
        ];
        const MCQ_COUNTS = [20, 20, 20, 0, 20, 20, 20, 0, 20, 20, 20, 0, 20, 20, 20, 0, 18];
        const ITEMS_PER_ROW = 4; 

        const DAILY_MISSIONS_POOL = [
            {id: 'm1', text: 'é€šé—œä»»æ„ 1 å€‹é—œå¡', reward: 30, type: 'clear_level', target: 1},
            {id: 'm2', text: 'ç²å¾— 1 æ¬¡ 100 åˆ†', reward: 50, type: 'perfect_score', target: 1},
            {id: 'm3', text: 'ä½¿ç”¨ 1 æ¬¡æç¤ºé“å…·', reward: 20, type: 'use_hint', target: 1},
            {id: 'm4', text: 'åœ¨ç‰¹æ®Šé—œå¡ç²å‹', reward: 40, type: 'clear_minigame', target: 1}
        ];

        const FUN_FACTS = [
            "æ—¥æœ¬å†¬å¤©é›–ç„¶å†·ï¼Œä½†æˆ¿é–“è£¡çš„ã€Œæš–æ¡Œã€æœƒè®“äººä¸æƒ³å‡ºä¾†ï¼", "ä½ çŸ¥é“å—ï¼Ÿå£½å¸åŸæœ¬æ˜¯ç‚ºäº†ä¿å­˜é­šè‚‰è€Œç™¼æ˜çš„å–”ï¼", "æœé®®åŠå³¶çš„å±±è„ˆå¾ˆå¤šï¼Œæ‰€ä»¥ä»¥å‰çš„äººèµ°è·¯æ¯”é¨é¦¬å¤šã€‚", "å¯’æš–æµäº¤æœƒçš„åœ°æ–¹ï¼Œæµ®æ¸¸ç”Ÿç‰©ç‰¹åˆ¥å¤šï¼Œé­šä¹Ÿç‰¹åˆ¥å¥½åƒï¼", "æ±äº¬å…¶å¯¦ä¸å¸¸ä¸‹å¤§é›ªï¼Œå› ç‚ºæœ‰å¤ªå¹³æ´‹æš–æµèª¿ç¯€ã€‚", "åŒ—æµ·é“çš„é›ªè³ªå¾ˆä¹¾çˆ½ï¼Œè¢«ç¨±ç‚ºã€Œç²‰é›ªã€ï¼Œæ»‘é›ªè¶…æ£’ï¼", "éŸ“åœ‹äººåƒå†·éºµæ˜¯åœ¨å†¬å¤©åƒçš„ï¼Œä»¥æ¯’æ”»æ¯’ï¼Ÿ", "åœ°åœ–ä¸Šçš„ã€ŒåŒ—æµ·é“ã€çœ‹èµ·ä¾†åƒä¸€éš»é­Ÿé­šã€‚", "æ—¥æœ¬æœ‰å…«ç™¾è¬ç¥æ˜ï¼Œé€£å»æ‰€éƒ½æœ‰ç¥å–”ï¼", "æº«çªæ˜¯éŸ“åœ‹å‚³çµ±çš„åœ°æš–ï¼Œå±è‚¡æœƒç†±ç†±çš„ã€‚", "æ—¥æœ¬çš„è‡ªå‹•è²©è³£æ©Ÿå¯†åº¦æ˜¯ä¸–ç•Œç¬¬ä¸€ï¼", "éŸ“åœ‹çš„ç­·å­æ˜¯æ‰çš„ï¼Œæ˜¯ç‚ºäº†é˜²æ­¢æ»¾å‹•ã€‚", "æ«»èŠ±é–‹èŠ±é æ¸¬å«åšã€Œæ«»å‰ç·šã€ã€‚", "æ—¥æœ¬å°å­¸ç”Ÿæ›¸åŒ…è¶…è²´ï¼Œå› ç‚ºå¯ä»¥ç”¨å…­å¹´ï¼", "éŸ“åœ‹äººéç”Ÿæ—¥è¦å–æµ·å¸¶æ¹¯ã€‚", "å¯Œå£«å±±å…¶å¯¦æ˜¯ç§äººçš„åœŸåœ°å–”ï¼", "æ¿Ÿå·å³¶æœ‰ä¸‰å¤šï¼šé¢¨å¤šã€çŸ³é ­å¤šã€å¥³äººå¤šã€‚"
        ];

        let allQuestions = [], userName = "", currentAvatar = "avatar_boy1.png";
        let currentLevelIdx = 0, currentQuizData = [], score = 0, timerInterval, timeRemaining = 20;
        const bgmPlayer = document.getElementById('bgm-player');
        const audioCorrect = new Audio('sounds/correct.mp3');
        const audioFail = new Audio('sounds/fail.mp3');
        const audioWin = new Audio('sounds/unlock.mp3');

        fetch('questions.json').then(res => res.json()).then(data => { allQuestions = data; renderQuickLogin(); }).catch(e => console.error("é¡Œç›®è®€å–å¤±æ•—", e));

        function getUserKey(key) { return userName + '_' + key; }
        function getUserData() {
            return JSON.parse(localStorage.getItem(getUserKey('userData'))) || {
                gold: 0, maxLevel: 0, levelScores: {}, inventory: { fifty: 2, hint: 2, skip: 2 }, stamps: [], daily: { date: '', tasks: [], claimed: false }
            };
        }
        function saveUserData(data) { localStorage.setItem(getUserKey('userData'), JSON.stringify(data)); updateUI(); }

        function updateUI() {
            let data = getUserData();
            document.querySelectorAll('#user-gold, #shop-gold-display').forEach(el => el.innerText = data.gold);
            let title = "ğŸ’ èƒŒåŒ…å®¢"; if (data.maxLevel >= 5) title = "ğŸ§­ æ¢éšªå®¶"; if (data.maxLevel >= 10) title = "ğŸ”ï¸ é ˜ä¸»"; if (data.maxLevel >= 16) title = "ğŸ‘‘ åœ°ç†å¤§å¸«";
            if(document.getElementById('user-title')) document.getElementById('user-title').innerText = title;
            ['fifty', 'hint', 'skip'].forEach(k => { if(document.getElementById('count-'+k)) document.getElementById('count-'+k).innerText = data.inventory[k]; });
        }

        function renderQuickLogin() {
            let users = JSON.parse(localStorage.getItem('savedUsers')) || [];
            let html = '';
            users.forEach(u => {
                let name = u.name || u; let avatar = u.avatar || 'avatar_boy1.png';
                html += `<div class="user-tag" onclick="login('${name}', '${avatar}')"><img src="images/${avatar}" style="width:20px;border-radius:50%;">${name}</div>`;
            });
            document.getElementById('quick-login-area').innerHTML = html;
        }
        function selectAvatar(img, el) { currentAvatar = img; document.querySelectorAll('.avatar-option').forEach(o => o.classList.remove('selected')); el.classList.add('selected'); }
        function loginAndStart() { let name = document.getElementById('username').value.trim(); if(!name) return alert("è«‹è¼¸å…¥åå­—"); login(name, currentAvatar); }
        function login(name, avatar) {
            userName = name; currentAvatar = avatar;
            let users = JSON.parse(localStorage.getItem('savedUsers')) || [];
            users = users.filter(u => (u.name || u) !== name); users.push({name, avatar});
            localStorage.setItem('savedUsers', JSON.stringify(users));
            checkDailyLogin(); showScreen('level-screen'); renderMap(); renderDailyTasks(); updateUI();
        }
        function logout() { location.reload(); }

        function checkDailyLogin() {
            let data = getUserData(); let today = new Date().toDateString();
            if (data.daily.date !== today) {
                data.daily.date = today; data.daily.claimed = false; data.daily.tasks = [];
                for(let i=0; i<3; i++) { let taskTemplate = DAILY_MISSIONS_POOL[Math.floor(Math.random()*DAILY_MISSIONS_POOL.length)]; data.daily.tasks.push({ ...taskTemplate, progress: 0, completed: false }); }
                data.gold += 50; document.getElementById('daily-reward-msg').style.display = 'block'; setTimeout(() => document.getElementById('daily-reward-msg').style.display = 'none', 3000);
                saveUserData(data);
            }
        }
        function renderDailyTasks() {
            let data = getUserData(); let html = '';
            data.daily.tasks.forEach((t, idx) => { html += `<div class="daily-item"><span>${t.text}</span><span style="color:${t.completed?'green':'gray'}">${t.completed ? 'âœ…' : (t.progress+'/'+t.target)}</span></div>`; });
            document.getElementById('daily-tasks-list').innerHTML = html;
        }
        function updateDailyProgress(type, amount=1) {
            let data = getUserData(); let updated = false;
            data.daily.tasks.forEach(t => {
                if (!t.completed && t.type === type) {
                    t.progress += amount;
                    if (t.progress >= t.target) { t.completed = true; data.gold += t.reward; alert(`å®Œæˆä»»å‹™ï¼š${t.text}ï¼ç²å¾— ${t.reward} é‡‘å¹£`); }
                    updated = true;
                }
            });
            if(updated) { saveUserData(data); renderDailyTasks(); }
        }

        function renderMap() {
            let container = document.getElementById('level-map'); container.innerHTML = '';
            let data = getUserData(); let maxLvl = data.maxLevel;
            let rows = []; for (let i = 0; i < LEVEL_TYPES.length; i += ITEMS_PER_ROW) rows.push(LEVEL_TYPES.slice(i, i + ITEMS_PER_ROW));
            rows.forEach((rowItems, rIdx) => {
                let rowDiv = document.createElement('div'); rowDiv.className = 'level-row' + (rIdx % 2 !== 0 ? ' reverse' : '');
                let startNum = rIdx * ITEMS_PER_ROW;
                rowItems.forEach((type, idx) => {
                    let absIdx = startNum + idx;
                    let btn = document.createElement('button'); btn.className = 'level-btn';
                    if (type.startsWith('game_')) btn.classList.add('special-level');
                    let label = `ç¬¬ ${absIdx+1} é—œ`;
                    if (type === 'game_match1' || type === 'game_match2') label = "ğŸ§© é€£é€£çœ‹";
                    if (type === 'game_map1') label = "ğŸ“ æ‰¾åœ°åœ–";
                    if (type === 'game_sort1') label = "ğŸ”¢ æ’åº";
                    let status = "ğŸ”’";
                    if (absIdx <= maxLvl) {
                        let score = data.levelScores[absIdx]; status = (score !== undefined) ? (score >= 60 ? "â­" : "ğŸš©") : "GO!";
                        btn.onclick = () => enterLevel(absIdx);
                    } else btn.disabled = true;
                    btn.innerHTML = `<div class="level-title">${label}</div><div class="level-score">${status}</div>`;
                    if (absIdx === maxLvl) { let ava = document.createElement('img'); ava.src = "images/" + currentAvatar; ava.className = "map-avatar"; btn.appendChild(ava); }
                    let wrapper = document.createElement('div'); wrapper.className = 'level-wrapper'; wrapper.appendChild(btn);
                    if (idx < rowItems.length - 1) { let arrow = document.createElement('div'); arrow.className = 'arrow-icon'; arrow.innerText = 'âœ'; if(rIdx % 2 !== 0) arrow.style.transform = "scaleX(-1)"; wrapper.appendChild(arrow); }
                    rowDiv.appendChild(wrapper);
                });
                container.appendChild(rowDiv);
            });
        }

        function enterLevel(idx) { currentLevelIdx = idx; let type = LEVEL_TYPES[idx]; if (type === 'mcq') startMCQ(idx); else startMiniGame(type); }

        function startMCQ(levelIdx) {
            let startQ = 0; for(let i=0; i<levelIdx; i++) startQ += MCQ_COUNTS[i];
            let count = MCQ_COUNTS[levelIdx];
            currentQuizData = allQuestions.slice(startQ, startQ + count);
            currentQuestionIndex = 0; score = 0;
            showScreen('quiz-content'); document.getElementById('level-title').innerText = `ç¬¬ ${levelIdx+1} é—œ`; document.getElementById('total-q-num').innerText = count;
            loadQuestion();
        }

        function loadQuestion() {
            let q = currentQuizData[currentQuestionIndex];
            document.getElementById('current-q-num').innerText = currentQuestionIndex + 1;
            document.getElementById('question-text').innerText = (currentQuestionIndex + 1) + ". " + q.question;
            let imgEl = document.getElementById('question-image');
            if(q.image) { imgEl.src = q.image; imgEl.style.display='block'; } else imgEl.style.display='none';
            let opts = document.getElementById('options-list'); opts.innerHTML = '';
            q.options.forEach(opt => { opts.innerHTML += `<button class="option-btn" onclick="checkMCQ(this, '${opt}')">${opt}</button>`; });
            document.getElementById('explanation').style.display = 'none'; document.getElementById('next-btn').style.display = 'none';
            resetTimer();
        }

        function checkMCQ(btn, ans) {
            clearInterval(timerInterval);
            let q = currentQuizData[currentQuestionIndex];
            let correctCode = q.answer.substring(0,1);
            let userCode = ans.substring(0,1); if (ans.startsWith('(')) userCode = ans.substring(1,2);
            document.querySelectorAll('.option-btn').forEach(b => b.disabled = true);
            if (userCode === correctCode) { btn.classList.add('correct'); score++; audioCorrect.play(); } else { btn.classList.add('wrong'); audioFail.play(); }
            document.getElementById('explanation-text').innerText = q.explanation; document.getElementById('explanation').style.display = 'block'; document.getElementById('next-btn').style.display = 'block';
        }

        function nextQuestion() { currentQuestionIndex++; if(currentQuestionIndex < currentQuizData.length) loadQuestion(); else endLevel(true); }

        function resetTimer() {
            timeRemaining = 20; document.getElementById('timer-bar').style.width = '100%'; clearInterval(timerInterval);
            timerInterval = setInterval(() => {
                timeRemaining--; document.getElementById('timer-bar').style.width = (timeRemaining/20*100)+'%';
                if(timeRemaining<=0) { clearInterval(timerInterval); let btns = document.querySelectorAll('.option-btn'); if(btns.length > 0) checkMCQ(btns[0], "WRONG"); }
            }, 1000);
        }

        function startMiniGame(type) {
            showScreen('minigame-screen');
            let container = document.getElementById('mg-container'); let title = document.getElementById('mg-title'); let instr = document.getElementById('mg-instruction'); container.innerHTML = '';
            if (type === 'game_match1') {
                title.innerText = "ğŸ§© é€£é€£çœ‹ï¼šæ´‹æµèˆ‡æ€§è³ª"; instr.innerText = "è«‹é»æ“Šå·¦é‚Šçš„æ€§è³ªï¼Œå†é»æ“Šå³é‚Šå°æ‡‰çš„æ´‹æµï¼";
                let pairs = [{left: "å¯’æµ (å‘å—æµ)", right: "è¦ªæ½®"}, {left: "æš–æµ (å‘åŒ—æµ)", right: "é»‘æ½®"}]; renderMatchingGame(container, pairs);
            } else if (type === 'game_map1') {
                title.innerText = "ğŸ“ åœ°åœ–é¡Œï¼šå°‹æ‰¾åŒ—æµ·é“"; instr.innerText = "è«‹é»æ“Šåœ°åœ–ä¸Šã€ŒåŒ—æµ·é“ã€çš„ä½ç½®ï¼";
                renderMapClickGame(container, 'mg_map_japan.jpg', {x:30, y:0, w:40, h:30});
            } else if (type === 'game_sort1') {
                title.innerText = "ğŸ”¢ æ’åºé¡Œï¼šæ—¥æœ¬å³¶å¶¼"; instr.innerText = "è«‹ä¾ã€Œç”±åŒ—åˆ°å—ã€çš„é †åºé»æ“Šä¸‹åˆ—å³¶å¶¼ï¼š";
                let items = ["åŒ—æµ·é“", "æœ¬å·", "å››åœ‹", "ä¹å·"]; renderSortingGame(container, items);
            } else if (type === 'game_match2') {
                title.innerText = "ğŸ§© é€£é€£çœ‹ï¼šåœ‹å®¶èˆ‡é¦–éƒ½"; instr.innerText = "è«‹é…å°åœ‹å®¶èˆ‡å…¶é¦–éƒ½ï¼š";
                let pairs = [{left: "æ—¥æœ¬", right: "æ±äº¬"}, {left: "å—éŸ“", right: "é¦–çˆ¾"}, {left: "åŒ—éŸ“", right: "å¹³å£¤"}]; renderMatchingGame(container, pairs);
            }
        }

        function renderMatchingGame(container, pairs) {
            let lefts = pairs.map(p => p.left); let rights = pairs.map(p => p.right).sort(()=>Math.random()-0.5);
            let html = '<div class="mg-match-row"><div style="flex:1;">' + lefts.map(t => `<div class="mg-item" onclick="selectMatch(this, 'L', '${t}')">${t}</div>`).join('') + '</div><div style="flex:1;">' + rights.map(t => `<div class="mg-item" onclick="selectMatch(this, 'R', '${t}')">${t}</div>`).join('') + '</div></div>';
            container.innerHTML = html; container.dataset.pairs = JSON.stringify(pairs); container.dataset.matches = 0;
        }
        let selectedL = null;
        function selectMatch(el, side, text) {
            if(el.classList.contains('matched')) return;
            if (side === 'L') { if(selectedL) selectedL.classList.remove('selected'); selectedL = el; el.classList.add('selected'); } 
            else {
                if (!selectedL) return;
                let pairs = JSON.parse(document.getElementById('mg-container').dataset.pairs);
                let correct = pairs.find(p => p.left === selectedL.innerText && p.right === text);
                if (correct) {
                    selectedL.classList.add('matched'); el.classList.add('matched'); audioCorrect.play(); selectedL = null;
                    let matches = document.querySelectorAll('.matched').length / 2; if (matches === pairs.length) setTimeout(() => endLevel(false, true), 1000);
                } else { audioFail.play(); selectedL.classList.remove('selected'); selectedL = null; alert("é…å°éŒ¯èª¤ï¼Œå†è©¦ä¸€æ¬¡ï¼"); }
            }
        }

        function renderMapClickGame(container, imgUrl, targetArea) { container.innerHTML = `<div class="mg-map-area" onclick="checkMapClick(event, ${JSON.stringify(targetArea)})"><img src="images/${imgUrl}" class="mg-map-img"></div>`; }
        function checkMapClick(e, target) {
            let rect = e.target.getBoundingClientRect();
            let x = (e.clientX - rect.left) / rect.width * 100; let y = (e.clientY - rect.top) / rect.height * 100;
            if (x >= target.x && x <= target.x + target.w && y >= target.y && y <= target.y + target.h) { audioCorrect.play(); alert("ç­”å°äº†ï¼"); endLevel(false, true); } 
            else { audioFail.play(); alert("ä¸å°å–”ï¼Œå†æ‰¾æ‰¾çœ‹ï¼"); }
        }

        function renderSortingGame(container, correctOrder) {
            let shuffled = [...correctOrder].sort(()=>Math.random()-0.5);
            let html = '<div id="mg-sort-pool" style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center;">';
            shuffled.forEach(item => { html += `<div class="mg-item" onclick="clickSort(this, '${item}')">${item}</div>`; });
            html += '</div><div id="mg-sort-ans" style="margin-top:20px; border-bottom:2px solid #333; min-height:40px; font-size:1.5em;"></div>';
            container.innerHTML = html; container.dataset.answer = JSON.stringify(correctOrder); container.dataset.current = '[]';
        }
        function clickSort(el, text) {
            el.style.visibility = 'hidden'; let ansDiv = document.getElementById('mg-sort-ans'); ansDiv.innerHTML += (ansDiv.innerHTML ? ' â†’ ' : '') + text;
            let current = JSON.parse(document.getElementById('mg-container').dataset.current); current.push(text); document.getElementById('mg-container').dataset.current = JSON.stringify(current);
            let correct = JSON.parse(document.getElementById('mg-container').dataset.answer);
            if (current.length === correct.length) {
                if (JSON.stringify(current) === JSON.stringify(correct)) { audioCorrect.play(); setTimeout(() => endLevel(false, true), 500); } 
                else { audioFail.play(); alert("é †åºéŒ¯èª¤ï¼Œé‡ä¾†ï¼"); startMiniGame('game_sort1'); }
            }
        }
        function checkMiniGame() {}

        function endLevel(isMCQ, isWin=false) {
            showScreen('score-box');
            let finalScore = isMCQ ? Math.round((score / currentQuizData.length) * 100) : (isWin ? 100 : 0);
            document.getElementById('final-score').innerText = finalScore; document.getElementById('final-name').innerText = userName;
            let earnedGold = finalScore; document.getElementById('earned-gold').innerText = earnedGold;
            let data = getUserData(); data.gold += earnedGold;
            let unlockMsg = document.getElementById('unlock-msg'); let newStampAlert = document.getElementById('new-stamp-alert');
            unlockMsg.style.display='none'; newStampAlert.style.display='none';

            if (finalScore >= 60) {
                if (currentLevelIdx === data.maxLevel && currentLevelIdx < LEVEL_TYPES.length - 1) { data.maxLevel++; unlockMsg.style.display = 'block'; }
                if (!data.levelScores[currentLevelIdx] || finalScore > data.levelScores[currentLevelIdx]) data.levelScores[currentLevelIdx] = finalScore;
                if (!data.stamps.includes(currentLevelIdx)) {
                    data.stamps.push(currentLevelIdx);
                    document.getElementById('new-stamp-img').src = `images/stamp_${currentLevelIdx+1 < 10 ? '0'+(currentLevelIdx+1) : currentLevelIdx+1}.png`;
                    newStampAlert.style.display = 'block';
                }
                updateDailyProgress('clear_level'); if(finalScore===100) updateDailyProgress('perfect_score'); if(isMCQ === false) updateDailyProgress('clear_minigame');
                confetti({ particleCount: 150, spread: 180 }); audioWin.play();
            }
            saveUserData(data);
        }

        function openPassport() {
            document.getElementById('passport-modal').style.display = 'flex';
            let grid = document.getElementById('passport-grid'); grid.innerHTML = ''; let data = getUserData();
            for(let i=0; i<LEVEL_TYPES.length; i++) {
                let hasStamp = data.stamps.includes(i); let num = i+1 < 10 ? '0'+(i+1) : (i+1);
                let div = document.createElement('div'); div.className = `stamp-item ${hasStamp ? 'unlocked' : ''}`;
                div.innerHTML = `<img src="images/stamp_${num}.png" class="stamp-img" onerror="this.src='data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI1MCIgaGVpZ2h0PSI1MCI+PHRleHQgeD0iNTAlIiB5PSI1MCUiIGR5PSIuM2VtIiB0ZXh0LWFuY2hvcj0ibWlkZGxlIiBmb250LXNpemU9IjMwIj7wn5SOPC90ZXh0Pjwvc3ZnPg=='">`;
                if (hasStamp) div.onclick = () => showFunFact(i);
                grid.appendChild(div);
            }
        }
        function showFunFact(idx) {
            let fact = FUN_FACTS[idx] || "æ­å–œé€šé—œï¼"; document.getElementById('ff-title').innerText = `ç¬¬ ${idx+1} é—œ å†·çŸ¥è­˜`;
            document.getElementById('ff-content').innerText = fact; document.getElementById('funfact-modal').style.display = 'flex';
        }

        function showScreen(id) { document.querySelectorAll('.quiz-container > div').forEach(el => { if(el.id && !el.id.includes('modal')) el.style.display = 'none'; }); document.getElementById(id).style.display = 'block'; }
        function closeModal(id) { document.getElementById(id).style.display = 'none'; }
        function openShop() { document.getElementById('shop-modal').style.display = 'flex'; document.getElementById('shop-gold-display').innerText = getUserData().gold; }
        function buyItem(item, cost) {
            let data = getUserData(); if (data.gold >= cost) { data.gold -= cost; data.inventory[item]++; saveUserData(data); alert("è³¼è²·æˆåŠŸï¼"); document.getElementById('shop-gold-display').innerText = data.gold; } else alert("é‡‘å¹£ä¸è¶³ï¼");
        }
        function usePowerUp(type) {
            let data = getUserData(); if (data.inventory[type] > 0) {
                data.inventory[type]--; saveUserData(data); updateDailyProgress('use_hint');
                if (type === 'fifty') {
                    let q = currentQuizData[currentQuestionIndex]; let correct = q.answer.substring(0,1);
                    let buttons = Array.from(document.querySelectorAll('.option-btn'));
                    let wrongs = buttons.filter(b => !b.innerText.startsWith('('+correct));
                    wrongs.slice(0, 2).forEach(b => b.style.visibility = 'hidden');
                } else if (type === 'hint') { alert(currentQuizData[currentQuestionIndex].explanation); } else if (type === 'skip') { nextQuestion(); }
            } else alert("é“å…·ä¸è¶³ï¼");
        }
        function showHistory() { showScreen('history-screen'); let list = document.getElementById('history-list'); list.innerHTML = '<li style="text-align:center;">(åŠŸèƒ½å»ºç½®ä¸­...)</li>'; }
    </script>
</body>
</html>